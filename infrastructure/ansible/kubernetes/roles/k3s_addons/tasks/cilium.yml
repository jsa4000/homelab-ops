---
- name: Install Cilium
  run_once: true
  when: inventory_hostname == groups['server'][0]
  block:

    - name: Create networking Namespace
      shell: |
        kubectl create namespace networking
      ignore_errors: true
      failed_when: false
      changed_when: false

    - name: Install Cilium Addon
      shell: |
        kubectl kustomize github.com/jsa4000/homelab-ops//clusters/{{ cluster_env }}/addons/networking/cilium?ref=main --enable-helm | kubectl apply -f -
      ignore_errors: true
      failed_when: false
      changed_when: false

    - name: Wait for Cilium resources
      vars:
        timeout: 35s
      command: >-
        {% if item.type == 'daemonset' %}
        kubectl wait pods --namespace={{ item.namespace }} --selector='{{ item.selector }}' --for=condition=Ready --timeout={{ timeout }}
        {% elif item.type == 'deployment' %}
        kubectl wait {{ item.type }}/{{ item.name }} --namespace={{ item.namespace }} --for=condition=Available --timeout={{ timeout }}
        {% else %}
        kubectl get {{ item.type }}/{{ item.name }} --namespace={{ item.namespace }}
        {% endif %}
      register: cilium_result
      changed_when: false
      with_items:
        - {name: cilium-operator, type: deployment, namespace: networking}
        - {name: cilium, type: daemonset, namespace: networking, selector: 'k8s-app=cilium'}
        - {name: hubble-relay, type: deployment, namespace: networking}
        - {name: hubble-ui, type: deployment, namespace: networking}
      until: cilium_result is succeeded
      retries: 30
      delay: 7
      loop_control:
        label: "{{ item.type }}/{{ item.name }}"

    - name: Update External Secrets
      shell: |
        kubectl kustomize github.com/jsa4000/homelab-ops//clusters/{{ cluster_env }}/addons/networking/cilium?ref=main --enable-helm | kubectl apply -f -
      ignore_errors: true
      failed_when: false
      changed_when: false
