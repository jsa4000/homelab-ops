<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Create a Homelab from Scratch using latest best practices, patterns and tools."><meta name=author content="Javier Santos"><link href=https://jsa4000.github.io/homelab-ops/layers/networking/cilium/ rel=canonical><link href=../../messaging/keda/ rel=prev><link href=../ddns/ rel=next><link rel=icon href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.5.3, mkdocs-material-9.5.13"><title>Cilium - Homelab</title><link rel=stylesheet href=../../../assets/stylesheets/main.7e359304.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../_static/custom.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script> <link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../../assets/javascripts/glightbox.min.js"></script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=teal data-md-color-accent=purple> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#cilium class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../.. title=Homelab class="md-header__button md-logo" aria-label=Homelab data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m19 2-5 4.5v11l5-4.5V2M6.5 5C4.55 5 2.45 5.4 1 6.5v14.66c0 .25.25.5.5.5.1 0 .15-.07.25-.07 1.35-.65 3.3-1.09 4.75-1.09 1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.31 4.75 1.06.1.05.15.03.25.03.25 0 .5-.25.5-.5V6.5c-.6-.45-1.25-.75-2-1V19c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6.5C10.55 5.4 8.45 5 6.5 5Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Homelab </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Cilium </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=teal data-md-color-accent=purple aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=teal data-md-color-accent=lime aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18V6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-2.69L23.31 12 20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69Z"/></svg> </label> </form> <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/jsa4000/homelab-ops title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> jsa4000/homelab-ops </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Homelab </a> </li> <li class=md-tabs__item> <a href=../../../blog/ class=md-tabs__link> Blog </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../messaging/keda/ class=md-tabs__link> Layers </a> </li> <li class=md-tabs__item> <a href=../../../sbc/armbian/ class=md-tabs__link> Sbc </a> </li> <li class=md-tabs__item> <a href=../../../tools/mkdocs/ class=md-tabs__link> Tools </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title=Homelab class="md-nav__button md-logo" aria-label=Homelab data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m19 2-5 4.5v11l5-4.5V2M6.5 5C4.55 5 2.45 5.4 1 6.5v14.66c0 .25.25.5.5.5.1 0 .15-.07.25-.07 1.35-.65 3.3-1.09 4.75-1.09 1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.31 4.75 1.06.1.05.15.03.25.03.25 0 .5-.25.5-.5V6.5c-.6-.45-1.25-.75-2-1V19c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6.5C10.55 5.4 8.45 5 6.5 5Z"/></svg> </a> Homelab </label> <div class=md-nav__source> <a href=https://github.com/jsa4000/homelab-ops title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> jsa4000/homelab-ops </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> <span class=md-ellipsis> Homelab </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> Blog </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Blog </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../blog/ class=md-nav__link> <span class=md-ellipsis> Blog </span> </a> </li> <li class=md-nav__item> <a href=../../.. class=md-nav__link> <span class=md-ellipsis> Archive </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> Layers </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=true> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Layers </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_1> <label class=md-nav__link for=__nav_3_1 id=__nav_3_1_label tabindex=0> <span class=md-ellipsis> Messaging </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_1_label aria-expanded=false> <label class=md-nav__title for=__nav_3_1> <span class="md-nav__icon md-icon"></span> Messaging </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../messaging/keda/ class=md-nav__link> <span class=md-ellipsis> Keda </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_2 checked> <label class=md-nav__link for=__nav_3_2 id=__nav_3_2_label tabindex=0> <span class=md-ellipsis> Networking </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_2_label aria-expanded=true> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> Networking </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Cilium </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Cilium </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#components class=md-nav__link> <span class=md-ellipsis> Components </span> </a> <nav class=md-nav aria-label=Components> <ul class=md-nav__list> <li class=md-nav__item> <a href=#cilium_1 class=md-nav__link> <span class=md-ellipsis> Cilium </span> </a> <nav class=md-nav aria-label=Cilium> <ul class=md-nav__list> <li class=md-nav__item> <a href=#the-cilium-agent class=md-nav__link> <span class=md-ellipsis> The Cilium agent </span> </a> </li> <li class=md-nav__item> <a href=#the-cilium-cli-client class=md-nav__link> <span class=md-ellipsis> The Cilium CLI client </span> </a> </li> <li class=md-nav__item> <a href=#the-cilium-operator class=md-nav__link> <span class=md-ellipsis> The Cilium operator </span> </a> </li> <li class=md-nav__item> <a href=#the-cni-plugin class=md-nav__link> <span class=md-ellipsis> The CNI plugin </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#hubble class=md-nav__link> <span class=md-ellipsis> Hubble </span> </a> <nav class=md-nav aria-label=Hubble> <ul class=md-nav__list> <li class=md-nav__item> <a href=#hubble-server class=md-nav__link> <span class=md-ellipsis> Hubble Server </span> </a> </li> <li class=md-nav__item> <a href=#hubble-relay class=md-nav__link> <span class=md-ellipsis> Hubble Relay </span> </a> </li> <li class=md-nav__item> <a href=#the-hubble-cli class=md-nav__link> <span class=md-ellipsis> The Hubble CLI </span> </a> </li> <li class=md-nav__item> <a href=#the-hubble-ui class=md-nav__link> <span class=md-ellipsis> The Hubble UI </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#ebpf class=md-nav__link> <span class=md-ellipsis> eBPF </span> </a> </li> <li class=md-nav__item> <a href=#data-store class=md-nav__link> <span class=md-ellipsis> Data Store </span> </a> <nav class=md-nav aria-label="Data Store"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#kubernetes-crds-default class=md-nav__link> <span class=md-ellipsis> Kubernetes CRDs (Default) </span> </a> </li> <li class=md-nav__item> <a href=#key-value-store class=md-nav__link> <span class=md-ellipsis> Key-Value Store </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#feature class=md-nav__link> <span class=md-ellipsis> Feature </span> </a> <nav class=md-nav aria-label=Feature> <ul class=md-nav__list> <li class=md-nav__item> <a href=#security class=md-nav__link> <span class=md-ellipsis> Security </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#features class=md-nav__link> <span class=md-ellipsis> Features </span> </a> <nav class=md-nav aria-label=Features> <ul class=md-nav__list> <li class=md-nav__item> <a href=#routing class=md-nav__link> <span class=md-ellipsis> Routing </span> </a> </li> <li class=md-nav__item> <a href=#kube-proxy-replacement class=md-nav__link> <span class=md-ellipsis> Kube Proxy Replacement </span> </a> </li> <li class=md-nav__item> <a href=#loadbalancer-ip-address-management-lb-ipam class=md-nav__link> <span class=md-ellipsis> LoadBalancer IP Address Management (LB-IPAM) </span> </a> </li> <li class=md-nav__item> <a href=#bgp-border-gateway-protocol class=md-nav__link> <span class=md-ellipsis> BGP (Border Gateway Protocol) </span> </a> </li> <li class=md-nav__item> <a href=#threat-model class=md-nav__link> <span class=md-ellipsis> Threat Model </span> </a> </li> <li class=md-nav__item> <a href=#observability class=md-nav__link> <span class=md-ellipsis> Observability </span> </a> <nav class=md-nav aria-label=Observability> <ul class=md-nav__list> <li class=md-nav__item> <a href=#service-dependencies-communication-map class=md-nav__link> <span class=md-ellipsis> Service dependencies &amp; communication map </span> </a> </li> <li class=md-nav__item> <a href=#network-monitoring-alerting class=md-nav__link> <span class=md-ellipsis> Network monitoring &amp; alerting </span> </a> </li> <li class=md-nav__item> <a href=#application-monitoring class=md-nav__link> <span class=md-ellipsis> Application monitoring </span> </a> </li> <li class=md-nav__item> <a href=#security-observability class=md-nav__link> <span class=md-ellipsis> Security observability </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#service-mesh class=md-nav__link> <span class=md-ellipsis> Service Mesh </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#installation class=md-nav__link> <span class=md-ellipsis> Installation </span> </a> <nav class=md-nav aria-label=Installation> <ul class=md-nav__list> <li class=md-nav__item> <a href=#cli class=md-nav__link> <span class=md-ellipsis> CLI </span> </a> </li> <li class=md-nav__item> <a href=#cni class=md-nav__link> <span class=md-ellipsis> CNI </span> </a> </li> <li class=md-nav__item> <a href=#hubble_1 class=md-nav__link> <span class=md-ellipsis> Hubble </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#demo class=md-nav__link> <span class=md-ellipsis> Demo </span> </a> <nav class=md-nav aria-label=Demo> <ul class=md-nav__list> <li class=md-nav__item> <a href=#deployment class=md-nav__link> <span class=md-ellipsis> Deployment </span> </a> </li> <li class=md-nav__item> <a href=#check-current-access class=md-nav__link> <span class=md-ellipsis> Check Current Access </span> </a> </li> <li class=md-nav__item> <a href=#apply-an-l3l4-policy class=md-nav__link> <span class=md-ellipsis> Apply an L3/L4 Policy </span> </a> </li> <li class=md-nav__item> <a href=#inspecting-the-policy class=md-nav__link> <span class=md-ellipsis> Inspecting the Policy </span> </a> </li> <li class=md-nav__item> <a href=#apply-and-test-http-aware-l7-policy class=md-nav__link> <span class=md-ellipsis> Apply and Test HTTP-aware L7 Policy </span> </a> </li> <li class=md-nav__item> <a href=#locking-down-external-access-with-dns-based-policies class=md-nav__link> <span class=md-ellipsis> Locking Down External Access with DNS-Based Policies </span> </a> <nav class=md-nav aria-label="Locking Down External Access with DNS-Based Policies"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#apply-dns-egress-policy class=md-nav__link> <span class=md-ellipsis> Apply DNS Egress Policy </span> </a> </li> <li class=md-nav__item> <a href=#dns-policies-using-patterns class=md-nav__link> <span class=md-ellipsis> DNS Policies Using Patterns </span> </a> </li> <li class=md-nav__item> <a href=#combining-dns-port-and-l7-rules class=md-nav__link> <span class=md-ellipsis> Combining DNS, Port and L7 Rules </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#inspecting-the-clusters-network-traffic-with-hubble-relay class=md-nav__link> <span class=md-ellipsis> Inspecting the cluster's network traffic with Hubble Relay </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#labs class=md-nav__link> <span class=md-ellipsis> Labs </span> </a> </li> <li class=md-nav__item> <a href=#references class=md-nav__link> <span class=md-ellipsis> References </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../ddns/ class=md-nav__link> <span class=md-ellipsis> DDNS (Dynamic DNS) </span> </a> </li> <li class=md-nav__item> <a href=../metallb/ class=md-nav__link> <span class=md-ellipsis> Metallb </span> </a> </li> <li class=md-nav__item> <a href=../nat/ class=md-nav__link> <span class=md-ellipsis> NAT (Network address translation) </span> </a> </li> <li class=md-nav__item> <a href=../traefik/ class=md-nav__link> <span class=md-ellipsis> Traefik </span> </a> </li> <li class=md-nav__item> <a href=../zigbee/ class=md-nav__link> <span class=md-ellipsis> Zigbee </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_3> <label class=md-nav__link for=__nav_3_3 id=__nav_3_3_label tabindex=0> <span class=md-ellipsis> Security </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> Security </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../security/cert-manager/ class=md-nav__link> <span class=md-ellipsis> Cert Manager </span> </a> </li> <li class=md-nav__item> <a href=../../security/external-secrets/ class=md-nav__link> <span class=md-ellipsis> External Secrets </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> Sbc </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Sbc </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_1> <label class=md-nav__link for=__nav_4_1 id=__nav_4_1_label tabindex=0> <span class=md-ellipsis> Armbian </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_1_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1> <span class="md-nav__icon md-icon"></span> Armbian </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../sbc/armbian/ class=md-nav__link> <span class=md-ellipsis> Installation </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_2> <label class=md-nav__link for=__nav_4_2 id=__nav_4_2_label tabindex=0> <span class=md-ellipsis> Dietpi </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_2_label aria-expanded=false> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> Dietpi </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../sbc/dietpi/ class=md-nav__link> <span class=md-ellipsis> DietPi OS </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_3> <label class=md-nav__link for=__nav_4_3 id=__nav_4_3_label tabindex=0> <span class=md-ellipsis> Orangepi </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_3_label aria-expanded=false> <label class=md-nav__title for=__nav_4_3> <span class="md-nav__icon md-icon"></span> Orangepi </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../sbc/orangepi/ class=md-nav__link> <span class=md-ellipsis> Orange Pi OS </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> Tools </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Tools </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../tools/mkdocs/ class=md-nav__link> <span class=md-ellipsis> MkDocs </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_2> <label class=md-nav__link for=__nav_5_2 id=__nav_5_2_label tabindex=0> <span class=md-ellipsis> Ansible </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_2_label aria-expanded=false> <label class=md-nav__title for=__nav_5_2> <span class="md-nav__icon md-icon"></span> Ansible </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../tools/ansible/ class=md-nav__link> <span class=md-ellipsis> Ansible </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_3> <label class=md-nav__link for=__nav_5_3 id=__nav_5_3_label tabindex=0> <span class=md-ellipsis> Byor </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_3_label aria-expanded=false> <label class=md-nav__title for=__nav_5_3> <span class="md-nav__icon md-icon"></span> Byor </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../tools/byor/ class=md-nav__link> <span class=md-ellipsis> Build my Radar </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_4> <label class=md-nav__link for=__nav_5_4 id=__nav_5_4_label tabindex=0> <span class=md-ellipsis> Certificates </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_4_label aria-expanded=false> <label class=md-nav__title for=__nav_5_4> <span class="md-nav__icon md-icon"></span> Certificates </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../tools/certificates/ class=md-nav__link> <span class=md-ellipsis> Certificates </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_5> <label class=md-nav__link for=__nav_5_5 id=__nav_5_5_label tabindex=0> <span class=md-ellipsis> Devpod </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5_5> <span class="md-nav__icon md-icon"></span> Devpod </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../tools/devpod/ class=md-nav__link> <span class=md-ellipsis> DevPod </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_6> <label class=md-nav__link for=__nav_5_6 id=__nav_5_6_label tabindex=0> <span class=md-ellipsis> Dns </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_6_label aria-expanded=false> <label class=md-nav__title for=__nav_5_6> <span class="md-nav__icon md-icon"></span> Dns </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../tools/dns/ class=md-nav__link> <span class=md-ellipsis> DNS </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_7> <label class=md-nav__link for=__nav_5_7 id=__nav_5_7_label tabindex=0> <span class=md-ellipsis> Gitops </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_7_label aria-expanded=false> <label class=md-nav__title for=__nav_5_7> <span class="md-nav__icon md-icon"></span> Gitops </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../tools/gitops/ class=md-nav__link> <span class=md-ellipsis> Gitops </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_8> <label class=md-nav__link for=__nav_5_8 id=__nav_5_8_label tabindex=0> <span class=md-ellipsis> Iam </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_8_label aria-expanded=false> <label class=md-nav__title for=__nav_5_8> <span class="md-nav__icon md-icon"></span> Iam </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../tools/iam/ class=md-nav__link> <span class=md-ellipsis> IAM </span> </a> </li> <li class=md-nav__item> <a href=../../../tools/iam/zidatel-commands/ class=md-nav__link> <span class=md-ellipsis> README </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_8_3> <label class=md-nav__link for=__nav_5_8_3 id=__nav_5_8_3_label tabindex=0> <span class=md-ellipsis> Service user jwt </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_5_8_3_label aria-expanded=false> <label class=md-nav__title for=__nav_5_8_3> <span class="md-nav__icon md-icon"></span> Service user jwt </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../tools/iam/service-user-jwt/ class=md-nav__link> <span class=md-ellipsis> Call a Secured API Using JSON Web Token (JWT) Profile </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_8_4> <label class=md-nav__link for=__nav_5_8_4 id=__nav_5_8_4_label tabindex=0> <span class=md-ellipsis> Tofu </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_5_8_4_label aria-expanded=false> <label class=md-nav__title for=__nav_5_8_4> <span class="md-nav__icon md-icon"></span> Tofu </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../tools/iam/tofu/ class=md-nav__link> <span class=md-ellipsis> OpenTofu </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_9> <label class=md-nav__link for=__nav_5_9 id=__nav_5_9_label tabindex=0> <span class=md-ellipsis> K3s </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_9_label aria-expanded=false> <label class=md-nav__title for=__nav_5_9> <span class="md-nav__icon md-icon"></span> K3s </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../tools/k3s/ class=md-nav__link> <span class=md-ellipsis> K3s </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_10> <label class=md-nav__link for=__nav_5_10 id=__nav_5_10_label tabindex=0> <span class=md-ellipsis> Manifest </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_10_label aria-expanded=false> <label class=md-nav__title for=__nav_5_10> <span class="md-nav__icon md-icon"></span> Manifest </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../tools/manifest/ class=md-nav__link> <span class=md-ellipsis> README </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_11> <label class=md-nav__link for=__nav_5_11 id=__nav_5_11_label tabindex=0> <span class=md-ellipsis> Microceph </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_11_label aria-expanded=false> <label class=md-nav__title for=__nav_5_11> <span class="md-nav__icon md-icon"></span> Microceph </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../tools/microceph/ class=md-nav__link> <span class=md-ellipsis> README </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_12> <label class=md-nav__link for=__nav_5_12 id=__nav_5_12_label tabindex=0> <span class=md-ellipsis> Qemu </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_12_label aria-expanded=false> <label class=md-nav__title for=__nav_5_12> <span class="md-nav__icon md-icon"></span> Qemu </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../tools/qemu/ class=md-nav__link> <span class=md-ellipsis> QEMU </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_13> <label class=md-nav__link for=__nav_5_13 id=__nav_5_13_label tabindex=0> <span class=md-ellipsis> Ssh </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_13_label aria-expanded=false> <label class=md-nav__title for=__nav_5_13> <span class="md-nav__icon md-icon"></span> Ssh </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../tools/ssh/ class=md-nav__link> <span class=md-ellipsis> SSH </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=cilium>Cilium</h1> <p><a class=glightbox href=https://cdn.jsdelivr.net/gh/cilium/cilium@main/Documentation/images/logo-dark.png data-type=image data-width=100% data-height=auto data-desc-position=bottom><img alt="Cilium Logo" src=https://cdn.jsdelivr.net/gh/cilium/cilium@main/Documentation/images/logo-dark.png></a></p> <p>Cilium is a networking, observability, and security solution with an eBPF-based dataplane. It provides a simple flat Layer 3 network (OSI Model) with the ability to span multiple clusters in either a native routing or overlay mode. It is L7-protocol aware and can enforce network policies on L3-L7 using an identity based security model that is decoupled from network addressing.</p> <p>Cilium implements distributed load balancing for traffic between pods and to external services, and is able to fully replace <code>kube-proxy</code>, using efficient hash tables in eBPF allowing for almost unlimited scale. It also supports advanced functionality like integrated ingress and egress gateway, bandwidth management and service mesh, and provides deep network and security visibility and monitoring.</p> <p>A new Linux kernel technology called <code>eBPF</code> is at the foundation of Cilium. It supports dynamic insertion of eBPF bytecode into the Linux kernel at various integration points such as: network IO, application sockets, and tracepoints to implement security, networking and visibility logic. eBPF is highly efficient and flexible. To learn more about eBPF, visit <code>eBPF.io</code>.</p> <p><a class=glightbox href=../../../images/cilium-overview.png data-type=image data-width=100% data-height=auto data-desc-position=bottom><img alt="Overview of Cilium features for networking, observability, service mesh, and runtime security" src=../../../images/cilium-overview.png></a></p> <p>This is an overview of the main functionalities of Cilium:</p> <ul> <li>Protect and secure APIs transparently</li> <li>Secure service to service communication based on identities</li> <li>Secure access to and from external services</li> <li>Simple Networking</li> <li>Load Balancing</li> <li>Bandwidth Management</li> <li>Monitoring and Troubleshooting</li> </ul> <h2 id=components>Components</h2> <p>A deployment of Cilium and Hubble consists of the following components running in a cluster:</p> <p><a class=glightbox href=../../../images/cilium-components.webp data-type=image data-width=100% data-height=auto data-desc-position=bottom><img alt=Hubble src=../../../images/cilium-components.webp></a></p> <h3 id=cilium_1>Cilium</h3> <h4 id=the-cilium-agent>The Cilium agent</h4> <p>The <strong>Cilium agent</strong> (<code>cilium-agent</code>) runs on each node in the cluster. At a high-level, the agent accepts configuration via Kubernetes or APIs that describes networking, service load-balancing, network policies, and visibility &amp; monitoring requirements.</p> <p>The Cilium agent listens for events from orchestration systems such as Kubernetes to learn when containers or workloads are started and stopped. It manages the eBPF programs which the Linux kernel uses to control all network access in / out of those containers.</p> <h4 id=the-cilium-cli-client>The Cilium CLI client</h4> <p>The <strong>Cilium CLI client</strong> (<code>cilium</code>) is a command-line tool that is installed along with the Cilium agent. It interacts with the REST API of the Cilium agent running on the same node. The CLI allows inspecting the state and status of the local agent. It also provides tooling to directly access the eBPF maps to validate their state.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>The in-agent Cilium CLI client described here <strong>should not</strong> be confused with the <a href=https://github.com/cilium/cilium-cli>command line tool</a> for quick-installing, managing and troubleshooting Cilium on Kubernetes clusters, which also has the name cilium. That tool is typically installed remote from the cluster, and uses <code>kubeconfig</code> information to access Cilium running on the cluster via the Kubernetes API.</p> </div> <h4 id=the-cilium-operator>The Cilium operator</h4> <p>The <strong>Cilium Operator</strong> is responsible for managing duties in the cluster which should logically be handled once for the entire cluster, rather than once for each node in the cluster. The Cilium operator is not in the critical path for any forwarding or network policy decision. A cluster will generally continue to function if the operator is temporarily unavailable. However, depending on the configuration, failure in availability of the operator can lead to:</p> <ul> <li>Delays in IP Address Management (IPAM) and thus delay in scheduling of new workloads if the operator is required to allocate new IP addresses</li> <li>Failure to update the kvstore heartbeat key which will lead agents to declare kvstore unhealthiness and restart.</li> </ul> <h4 id=the-cni-plugin>The CNI plugin</h4> <p>The <strong>CNI plugin</strong> (<code>cilium-cni</code>) is invoked by Kubernetes when a pod is scheduled or terminated on a node. It interacts with the Cilium API of the node to trigger the necessary datapath configuration to provide networking, load-balancing and network policies for the pod.</p> <h3 id=hubble>Hubble</h3> <h4 id=hubble-server>Hubble Server</h4> <p>The <strong>Hubble server</strong> runs on each node and retrieves the eBPF-based visibility from Cilium. It is embedded into the <strong>Cilium agent</strong> in order to achieve high performance and low-overhead. It offers a gRPC service to retrieve flows and Prometheus metrics.</p> <h4 id=hubble-relay>Hubble Relay</h4> <p><strong>Hubble Relay</strong> (<code>hubble-relay</code>) is a standalone component which is aware of all running Hubble servers and offers cluster-wide visibility by connecting to their respective gRPC APIs and providing an API that represents all servers in the cluster.</p> <h4 id=the-hubble-cli>The Hubble CLI</h4> <p>The <strong>Hubble CLI</strong> (<code>hubble</code>) is a command-line tool able to connect to either the gRPC API of <code>hubble-relay</code> or the local server to retrieve flow events.</p> <h4 id=the-hubble-ui>The Hubble UI</h4> <p>The <strong>Hubble UI</strong> (<code>hubble-ui</code>) utilizes relay-based visibility to provide a graphical service dependency and connectivity map.</p> <h3 id=ebpf>eBPF</h3> <p>Historically, the operating system has always been an ideal place to implement observability, security, and networking functionality due to the kernel's privileged ability to oversee and control the entire system. At the same time, an operating system kernel is hard to evolve due to its central role and high requirement towards stability and security. The rate of innovation at the operating system level has thus traditionally been lower compared to functionality implemented outside of the operating system.</p> <p><strong>BPF</strong> (Berkeley Packet Filter) is a revolutionary technology with origins in the Linux kernel that can run sandboxed programs in a privileged context such as the operating system kernel. It is used to safely and efficiently <strong>extend</strong> the capabilities of the <strong>kernel</strong> without requiring to change kernel source code or load kernel modules.</p> <p><strong>eBPF</strong> (extended Berkeley Packet Filter) is a modern Linux kernel bytecode interpreter originally introduced to filter network packets, e.g. tcpdump and socket filters at <strong>runtime</strong>. It has been extended with additional data structures such as hashtable and arrays as well as additional actions to support packet mangling, forwarding, encapsulation, etc. An in-kernel verifier ensures that eBPF programs are safe to run and a <code>Just-In-Time</code> (JIT) compiler converts the bytecode to CPU architecture specific instructions for native execution efficiency. eBPF programs can be run at various <strong>hooking points</strong> (events) in the kernel such as for incoming and outgoing packets, execute binaries, etc..</p> <p><a class=glightbox href=../../../images/ebpf-overview.png data-type=image data-width=100% data-height=auto data-desc-position=bottom><img alt="eBPF Overview" src=../../../images/ebpf-overview.png></a></p> <p>Today, <strong>eBPF</strong> is used extensively to drive a wide variety of use cases: Providing high-performance networking and load-balancing in modern data centers and cloud native environments, extracting fine-grained security observability data at low overhead, helping application developers trace applications and observability, providing insights for performance troubleshooting, preventive application and container runtime security enforcement, and much more. The possibilities are endless, and the innovation that eBPF is unlocking has only just begun.</p> <p>Although <strong>eBPF</strong> was initially designed for the <strong>kernel</strong>, its tremendous potential in <strong>user</strong> space, coupled with the kernel's GPL LICENSE restrictions. These runtimes allowed developers to execute eBPF bytecode <strong>outside</strong> the kernel, breaking free from GPL license restrictions and offering a more intuitive and convenient debugging environment.</p> <p><a class=glightbox href=../../../images/ebpf_arch.webp data-type=image data-width=100% data-height=auto data-desc-position=bottom><img alt="eBPF Architecture" src=../../../images/ebpf_arch.webp></a></p> <p><strong>Cilium</strong> is capable of probing the Linux kernel for available features and will automatically make use of more recent features as they are detected.</p> <p><a class=glightbox href=../../../images/cilium_arch.webp data-type=image data-width=100% data-height=auto data-desc-position=bottom><img alt="eBPF-Cilium Architecture" src=../../../images/cilium_arch.webp></a></p> <h3 id=data-store>Data Store</h3> <p>Cilium requires a data store to propagate state between agents. It supports the following data stores:</p> <h4 id=kubernetes-crds-default>Kubernetes CRDs (Default)</h4> <p>The default choice to store any data and propagate state is to use Kubernetes custom resource definitions (CRDs). CRDs are offered by Kubernetes for cluster components to represent configurations and state via Kubernetes resources.</p> <h4 id=key-value-store>Key-Value Store</h4> <p>All requirements for state storage and propagation can be met with Kubernetes CRDs as configured in the default configuration of Cilium. A key-value store can optionally be used as an optimization to improve the scalability of a cluster as change notifications and storage requirements are more efficient with direct key-value store usage.</p> <p>The currently supported key-value stores are base on <code>etcd</code>.</p> <h2 id=feature>Feature</h2> <h3 id=security>Security</h3> <ul> <li>Network Traffic</li> <li>File Activity</li> <li>Running Executables</li> <li>Changing Priviledges</li> </ul> <h2 id=features>Features</h2> <h3 id=routing>Routing</h3> <p><a href=https://docs.cilium.io/en/stable/network/concepts/routing/ >Routing</a></p> <h3 id=kube-proxy-replacement>Kube Proxy Replacement</h3> <p>The kube-proxy replacement offered by Cilium's CNI is a very powerful feature which can increase performance for large Kubernetes clusters. This feature uses an eBPF data plane to replace the kube-proxy implementations offered by Kubernetes distributions typically implemented with either iptables or ipvs. When using other networking infrastructure, the otherwise hidden Cilium eBPF implementation used to replace kube-proxy can bleed through and provide unintended behaviors. We see this when trying to use Istio service mesh with Cilium's kube-proxy replacement: kube-proxy replacement, by default, <strong>breaks</strong> Istio.</p> <h3 id=loadbalancer-ip-address-management-lb-ipam>LoadBalancer IP Address Management (LB-IPAM)</h3> <p>In Cilium 1.13, it was added support for <strong>LoadBalancer IP Address Management</strong> (LB-IPAM) and the ability to <em>allocate</em> IP addresses to Kubernetes Services of the type <code>LoadBalancer</code>.</p> <p><a class=glightbox href=../../../images/ipam-diagram.webp data-type=image data-width=100% data-height=auto data-desc-position=bottom><img alt="IP Address Management (LB-IPAM)" src=../../../images/ipam-diagram.webp></a></p> <p>For users who do not want to use <strong>BGP</strong> or that just want to make these IP addresses accessible over the <strong>local network</strong>, in Cilium 1.14 a new feature called <strong>L2 Announcements</strong> was added. When you deploy a <em>L2 Announcement Policy</em>, Cilium will start responding to Address Resolution Protocol (<code>ARP</code>) requests from local clients for ExternalIPs and/or LoadBalancer IPs. Only one node at a time are attached to the IP Address and when a nodes dies cilium will perform another leader election to stablish the new node with the IP.</p> <p>note !!!</p> <div class=highlight><pre><span></span><code>L2 is **not** doing real load balancing over your requests to the different nodes, since it uses `ARP` to get the current node attached to that IP; only one node can be attached to that IP Address. In order to use load balancing you may use different modes such as `BGP` or real load balancers.
</code></pre></div> <p><a class=glightbox href=../../../images/l2-announcement.png data-type=image data-width=100% data-height=auto data-desc-position=bottom><img alt="L2 Announcements" src=../../../images/l2-announcement.png></a></p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Typically, this would have required a tool like <code>MetalLB</code> but Cilium now natively supports this functionality. Cilium doesn't use <code>MetalLB</code> anymore, now it uses its own <code>BGP</code> speaker made with <code>gobgp</code>. They used it initially until they reached feature parity with gobgp.</p> </div> <p><code>LB-IPAM</code> works seamlessly with Cilium <code>BGP</code>. The IP addresses allocated by Cilium can be advertised to <code>BGP</code> peers to integrate your cluster with the rest of your network.</p> <p>Cloud providers natively provide this feature for managed Kubernetes Services and therefore this feature is more one for self-managed Kubernetes deployments or home labs.</p> <h3 id=bgp-border-gateway-protocol>BGP (Border Gateway Protocol)</h3> <p>BGP is a routing protocol.</p> <p>DNS (domain name system) servers provide the IP address, but BGP provides the most efficient way to reach that IP address. Roughly speaking, if DNS is the Internet's address book, then BGP is the Internet's road map (Tomtom).</p> <h3 id=threat-model>Threat Model</h3> <p><a href=https://docs.cilium.io/en/latest/security/threat-model/ >Threat Model</a></p> <h3 id=observability>Observability</h3> <p><strong>Hubble</strong> is a fully distributed networking and security observability platform. It is built on top of Cilium and eBPF to enable deep visibility into the communication and behavior of services as well as the networking infrastructure in a completely transparent manner.</p> <p>By building on top of Cilium, Hubble can leverage eBPF for visibility. By relying on eBPF, all visibility is programmable and allows for a dynamic approach that minimizes overhead while providing deep and detailed visibility as required by users. Hubble has been created and specifically designed to make best use of these new eBPF powers.</p> <p><a class=glightbox href=../../../images/cilium-hubble.webp data-type=image data-width=100% data-height=auto data-desc-position=bottom><img alt=Hubble src=../../../images/cilium-hubble.webp></a></p> <p>Hubble can answer questions such as:</p> <h4 id=service-dependencies-communication-map>Service dependencies &amp; communication map</h4> <ul> <li>What services are communicating with each other? How frequently? What does the service dependency graph look like?</li> <li>What HTTP calls are being made? What Kafka topics does a service consume from or produce to?</li> </ul> <h4 id=network-monitoring-alerting>Network monitoring &amp; alerting</h4> <ul> <li>Is any network communication failing? Why is communication failing? Is it DNS? Is it an application or network problem? Is the communication broken on layer 4 (TCP) or layer 7 (HTTP)?</li> <li>Which services have experienced a DNS resolution problem in the last 5 minutes? Which services have experienced an interrupted TCP connection recently or have seen connections timing out? What is the rate of unanswered TCP SYN requests?</li> </ul> <h4 id=application-monitoring>Application monitoring</h4> <ul> <li>What is the rate of 5xx or 4xx HTTP response codes for a particular service or across all clusters?</li> <li>What is the 95th and 99th percentile latency between HTTP requests and responses in my cluster? Which services are performing the worst? What is the latency between two services?</li> </ul> <h4 id=security-observability>Security observability</h4> <ul> <li>Which services had connections blocked due to network policy? What services have been accessed from outside the cluster? Which services have resolved a particular DNS name?</li> </ul> <h3 id=service-mesh>Service Mesh</h3> <p><a href=https://docs.cilium.io/en/stable/network/servicemesh/ >Service Mesh</a></p> <h2 id=installation>Installation</h2> <p>These are specific instructions on how to install Cilium depending on the Kubernetes cluster. However, the cilium installer will attempt to automatically pick the best configuration options for you. Check other installation options for distribution/platform specific to choose the ideal default configuration for each.</p> <h3 id=cli>CLI</h3> <p>The Cilium CLI can be used to install Cilium, inspect the state of a Cilium installation, and enable/disable various features (e.g. clustermesh, Hubble).</p> <p>Cilium cli can be installed in different ways using following <a href=https://docs.cilium.io/en/stable/gettingstarted/k8s-install-default/ >instructions</a>.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=c1># Use homebrew to install cilium cli</span>
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>brew<span class=w> </span>install<span class=w> </span>cilium-cli
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a>
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=c1># Test the version</span>
<a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a>cilium<span class=w> </span>version<span class=w> </span>--client
<a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a>
<a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a>cilium-cli:<span class=w> </span>v0.16.4<span class=w> </span>compiled<span class=w> </span>with<span class=w> </span>go1.22.1<span class=w> </span>on<span class=w> </span>darwin/arm64
<a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a>cilium<span class=w> </span>image<span class=w> </span><span class=o>(</span>default<span class=o>)</span>:<span class=w> </span>v1.15.3
<a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a>cilium<span class=w> </span>image<span class=w> </span><span class=o>(</span>stable<span class=o>)</span>:<span class=w> </span>v1.15.3
</code></pre></div> <h3 id=cni>CNI</h3> <p>There are several ways to install Cilium by using cilium cli, helm, kustomize, etc... In addition, cilium is recommended to be installed in a kubernetes distribution with no <strong>CNI</strong> pre-installed. There are several ways to prevent CNI to be installed in some distributions such as <code>K3s</code>, <code>KinD</code>, etc..</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Depending on the kubernetes distribution GKE, AKS, EKS, Openshift, K3s, etc.. cilium need to be installed using custom configuration.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=c1># For K3s cluster it&#39;s necessary to disable current CNI (flannel) and Network Policies.</span>
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a>curl<span class=w> </span>-sfL<span class=w> </span>https://get.k3s.io<span class=w> </span><span class=p>|</span><span class=w> </span><span class=nv>INSTALL_K3S_EXEC</span><span class=o>=</span><span class=s1>&#39;--flannel-backend=none --disable-network-policy&#39;</span><span class=w> </span>sh<span class=w> </span>-
</code></pre></div> </div> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=c1># Using the cilium cli, this will use helm behind the scenes.</span>
<a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a>cilium<span class=w> </span>install<span class=w> </span>--version<span class=w> </span><span class=m>1</span>.15.3
<a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a>
<a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=c1># Or Using directly helm</span>
<a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a>helm<span class=w> </span>repo<span class=w> </span>add<span class=w> </span>cilium<span class=w> </span>https://helm.cilium.io/
<a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a>helm<span class=w> </span>install<span class=w> </span>cilium<span class=w> </span>cilium/cilium<span class=w> </span>--version<span class=w> </span><span class=m>1</span>.15.3<span class=w> </span><span class=se>\</span>
<a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=w>   </span>--namespace<span class=w> </span>kube-system<span class=w> </span><span class=se>\</span>
<a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=w>   </span>--set<span class=w> </span>operator.replicas<span class=o>=</span><span class=m>1</span>
</code></pre></div> <div class="admonition restart unmanaged pods"> <p class=admonition-title>Restart</p> <p>If you did not create a cluster with the nodes tainted with the taint <code>node.cilium.io/agent-not-ready</code>, then unmanaged pods <strong>need</strong> to be restarted manually. Restart all already running pods which are not running in host-networking mode to ensure that Cilium starts managing them. This is required to ensure that all pods which have been running before Cilium was deployed have network connectivity provided by Cilium and NetworkPolicy applies to them.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a>kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>--all-namespaces<span class=w> </span>-o<span class=w> </span>custom-columns<span class=o>=</span>NAMESPACE:.metadata.namespace,NAME:.metadata.name,HOSTNETWORK:.spec.hostNetwork<span class=w> </span>--no-headers<span class=o>=</span><span class=nb>true</span><span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span><span class=s1>&#39;&lt;none&gt;&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>awk<span class=w> </span><span class=s1>&#39;{print &quot;-n &quot;$1&quot; &quot;$2}&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>xargs<span class=w> </span>-L<span class=w> </span><span class=m>1</span><span class=w> </span>-r<span class=w> </span>kubectl<span class=w> </span>delete<span class=w> </span>pod
</code></pre></div> </div> <p>If the containers have a <code>CrashLoopBackOff</code> status after the installation, that means there probable there is other <code>CNI</code> already installed. Check the K3s configuration or installation scripts.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=nv>level</span><span class=o>=</span>info<span class=w> </span><span class=nv>msg</span><span class=o>=</span><span class=s2>&quot;Stop hook executed&quot;</span><span class=w> </span><span class=nv>duration</span><span class=o>=</span><span class=s2>&quot;549.792µs&quot;</span><span class=w> </span><span class=k>function</span><span class=o>=</span><span class=s2>&quot;gops.registerGopsHooks.func2 (pkg/gops/cell.go:50)&quot;</span><span class=w> </span><span class=nv>subsys</span><span class=o>=</span>hive
<a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=nv>level</span><span class=o>=</span>fatal<span class=w> </span><span class=nv>msg</span><span class=o>=</span><span class=s2>&quot;failed to start: daemon creation failed: error while initializing daemon: failed while reinitializing datapath: failed to setup vxlan tunnel device: setting up vxlan device: creating vxlan device: setting up device cilium_vxlan: address already in use&quot;</span><span class=w> </span><span class=nv>subsys</span><span class=o>=</span>daemon
<a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a>´´´
<a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a>
<a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a>Validate<span class=w> </span>Cilium<span class=w> </span>has<span class=w> </span>been<span class=w> </span>properly<span class=w> </span>installed<span class=w> </span>into<span class=w> </span>kubernetes<span class=w> </span>cluster<span class=w> </span>running<span class=w> </span>following<span class=w> </span>command.
<a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a>
<a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=sb>```</span>bash
<a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a><span class=c1># Check cilium status by using the following command</span>
<a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a>cilium<span class=w> </span>status<span class=w> </span>--wait<span class=w> </span>-n<span class=w> </span>networking
<a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a>
<a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a><span class=w>    </span>/¯¯<span class=se>\</span>
<a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a><span class=w> </span>/¯¯<span class=se>\_</span>_/¯¯<span class=se>\ </span><span class=w>   </span>Cilium:<span class=w>             </span>OK
<a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a><span class=w> </span><span class=se>\_</span>_/¯¯<span class=se>\_</span>_/<span class=w>    </span>Operator:<span class=w>           </span>OK
<a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a><span class=w> </span>/¯¯<span class=se>\_</span>_/¯¯<span class=se>\ </span><span class=w>   </span>Envoy<span class=w> </span>DaemonSet:<span class=w>    </span>disabled<span class=w> </span><span class=o>(</span>using<span class=w> </span>embedded<span class=w> </span>mode<span class=o>)</span>
<a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a><span class=w> </span><span class=se>\_</span>_/¯¯<span class=se>\_</span>_/<span class=w>    </span>Hubble<span class=w> </span>Relay:<span class=w>       </span>OK
<a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a><span class=w>    </span><span class=se>\_</span>_/<span class=w>       </span>ClusterMesh:<span class=w>        </span>disabled
<a id=__codelineno-4-17 name=__codelineno-4-17 href=#__codelineno-4-17></a>
<a id=__codelineno-4-18 name=__codelineno-4-18 href=#__codelineno-4-18></a>Deployment<span class=w>             </span>hubble-ui<span class=w>          </span>Desired:<span class=w> </span><span class=m>1</span>,<span class=w> </span>Ready:<span class=w> </span><span class=m>1</span>/1,<span class=w> </span>Available:<span class=w> </span><span class=m>1</span>/1
<a id=__codelineno-4-19 name=__codelineno-4-19 href=#__codelineno-4-19></a>Deployment<span class=w>             </span>cilium-operator<span class=w>    </span>Desired:<span class=w> </span><span class=m>1</span>,<span class=w> </span>Ready:<span class=w> </span><span class=m>1</span>/1,<span class=w> </span>Available:<span class=w> </span><span class=m>1</span>/1
<a id=__codelineno-4-20 name=__codelineno-4-20 href=#__codelineno-4-20></a>Deployment<span class=w>             </span>hubble-relay<span class=w>       </span>Desired:<span class=w> </span><span class=m>1</span>,<span class=w> </span>Ready:<span class=w> </span><span class=m>1</span>/1,<span class=w> </span>Available:<span class=w> </span><span class=m>1</span>/1
<a id=__codelineno-4-21 name=__codelineno-4-21 href=#__codelineno-4-21></a>DaemonSet<span class=w>              </span>cilium<span class=w>             </span>Desired:<span class=w> </span><span class=m>3</span>,<span class=w> </span>Ready:<span class=w> </span><span class=m>3</span>/3,<span class=w> </span>Available:<span class=w> </span><span class=m>3</span>/3
<a id=__codelineno-4-22 name=__codelineno-4-22 href=#__codelineno-4-22></a>Containers:<span class=w>            </span>hubble-relay<span class=w>       </span>Running:<span class=w> </span><span class=m>1</span>
<a id=__codelineno-4-23 name=__codelineno-4-23 href=#__codelineno-4-23></a><span class=w>                       </span>cilium<span class=w>             </span>Running:<span class=w> </span><span class=m>3</span>
<a id=__codelineno-4-24 name=__codelineno-4-24 href=#__codelineno-4-24></a><span class=w>                       </span>hubble-ui<span class=w>          </span>Running:<span class=w> </span><span class=m>1</span>
<a id=__codelineno-4-25 name=__codelineno-4-25 href=#__codelineno-4-25></a><span class=w>                       </span>cilium-operator<span class=w>    </span>Running:<span class=w> </span><span class=m>1</span>
<a id=__codelineno-4-26 name=__codelineno-4-26 href=#__codelineno-4-26></a>Cluster<span class=w> </span>Pods:<span class=w>          </span><span class=m>5</span>/5<span class=w> </span>managed<span class=w> </span>by<span class=w> </span>Cilium
<a id=__codelineno-4-27 name=__codelineno-4-27 href=#__codelineno-4-27></a>Helm<span class=w> </span>chart<span class=w> </span>version:
<a id=__codelineno-4-28 name=__codelineno-4-28 href=#__codelineno-4-28></a>Image<span class=w> </span>versions<span class=w>         </span>hubble-relay<span class=w>       </span>quay.io/cilium/hubble-relay:v1.15.3@sha256:b9c6431aa4f22242a5d0d750c621d9d04bdc25549e4fb1116bfec98dd87958a2:<span class=w> </span><span class=m>1</span>
<a id=__codelineno-4-29 name=__codelineno-4-29 href=#__codelineno-4-29></a><span class=w>                       </span>cilium<span class=w>             </span>quay.io/cilium/cilium:v1.15.3@sha256:da74ab61d1bc665c1c088dff41d5be388d252ca5800f30c7d88844e6b5e440b0:<span class=w> </span><span class=m>3</span>
<a id=__codelineno-4-30 name=__codelineno-4-30 href=#__codelineno-4-30></a><span class=w>                       </span>hubble-ui<span class=w>          </span>quay.io/cilium/hubble-ui:v0.13.0@sha256:7d663dc16538dd6e29061abd1047013a645e6e69c115e008bee9ea9fef9a6666:<span class=w> </span><span class=m>1</span>
<a id=__codelineno-4-31 name=__codelineno-4-31 href=#__codelineno-4-31></a><span class=w>                       </span>hubble-ui<span class=w>          </span>quay.io/cilium/hubble-ui-backend:v0.13.0@sha256:1e7657d997c5a48253bb8dc91ecee75b63018d16ff5e5797e5af367336bc8803:<span class=w> </span><span class=m>1</span>
<a id=__codelineno-4-32 name=__codelineno-4-32 href=#__codelineno-4-32></a><span class=w>                       </span>cilium-operator<span class=w>    </span>quay.io/cilium/operator-generic:v1.15.3@sha256:c97f23161906b82f5c81a2d825b0646a5aa1dfb4adf1d49cbb87815079e69d61:<span class=w> </span><span class=m>1</span>
<a id=__codelineno-4-33 name=__codelineno-4-33 href=#__codelineno-4-33></a>
<a id=__codelineno-4-34 name=__codelineno-4-34 href=#__codelineno-4-34></a><span class=c1># Check cilium configuration options</span>
<a id=__codelineno-4-35 name=__codelineno-4-35 href=#__codelineno-4-35></a>cilium<span class=w> </span>config<span class=w> </span>view<span class=w> </span>-n<span class=w> </span>networking
<a id=__codelineno-4-36 name=__codelineno-4-36 href=#__codelineno-4-36></a>
<a id=__codelineno-4-37 name=__codelineno-4-37 href=#__codelineno-4-37></a><span class=c1># Filter configuration by keyword</span>
<a id=__codelineno-4-38 name=__codelineno-4-38 href=#__codelineno-4-38></a>cilium<span class=w> </span>config<span class=w> </span>view<span class=w> </span>-n<span class=w> </span>networking<span class=w>  </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span>l2
<a id=__codelineno-4-39 name=__codelineno-4-39 href=#__codelineno-4-39></a>
<a id=__codelineno-4-40 name=__codelineno-4-40 href=#__codelineno-4-40></a>enable-l2-announcements<span class=w>                           </span><span class=nb>true</span>
<a id=__codelineno-4-41 name=__codelineno-4-41 href=#__codelineno-4-41></a>enable-l2-neigh-discovery<span class=w>                         </span><span class=nb>true</span>
</code></pre></div> <p>Run the following command to validate that your cluster has proper network connectivity.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=c1># Check the connectivity test</span>
<a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>cilium<span class=w> </span>connectivity<span class=w> </span><span class=nb>test</span><span class=w> </span>-n<span class=w> </span>networking
<a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a>
<a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=c1># Check for any errors occurs during the tests.</span>
<a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a>
<a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a>✅<span class=w> </span>All<span class=w> </span><span class=m>47</span><span class=w> </span>tests<span class=w> </span><span class=o>(</span><span class=m>500</span><span class=w> </span>actions<span class=o>)</span><span class=w> </span>successful,<span class=w> </span><span class=m>28</span><span class=w> </span>tests<span class=w> </span>skipped,<span class=w> </span><span class=m>0</span><span class=w> </span>scenarios<span class=w> </span>skipped.
<a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a>
<a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a><span class=c1># Check the connectivity performance test</span>
<a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a>cilium<span class=w> </span>connectivity<span class=w> </span>perf<span class=w> </span>-n<span class=w> </span>networking
<a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a>
<a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a>
<a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a>🔥<span class=w> </span>Network<span class=w> </span>Performance<span class=w> </span>Test<span class=w> </span>Summary:
<a id=__codelineno-5-13 name=__codelineno-5-13 href=#__codelineno-5-13></a>--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
<a id=__codelineno-5-14 name=__codelineno-5-14 href=#__codelineno-5-14></a>📋<span class=w> </span>Scenario<span class=w>        </span><span class=p>|</span><span class=w> </span>Node<span class=w>       </span><span class=p>|</span><span class=w> </span>Test<span class=w>            </span><span class=p>|</span><span class=w> </span>Duration<span class=w>        </span><span class=p>|</span><span class=w> </span>Min<span class=w>             </span><span class=p>|</span><span class=w> </span>Mean<span class=w>            </span><span class=p>|</span><span class=w> </span>Max<span class=w>             </span><span class=p>|</span><span class=w> </span>P50<span class=w>             </span><span class=p>|</span><span class=w> </span>P90<span class=w>             </span><span class=p>|</span><span class=w> </span>P99<span class=w>             </span><span class=p>|</span><span class=w> </span>Transaction<span class=w> </span>rate<span class=w> </span>OP/s
<a id=__codelineno-5-15 name=__codelineno-5-15 href=#__codelineno-5-15></a>--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
<a id=__codelineno-5-16 name=__codelineno-5-16 href=#__codelineno-5-16></a>📋<span class=w> </span>pod-to-pod<span class=w>      </span><span class=p>|</span><span class=w> </span>same-node<span class=w>  </span><span class=p>|</span><span class=w> </span>TCP_RR<span class=w>          </span><span class=p>|</span><span class=w> </span>10s<span class=w>             </span><span class=p>|</span><span class=w> </span>21µs<span class=w>            </span><span class=p>|</span><span class=w> </span><span class=m>57</span>.46µs<span class=w>         </span><span class=p>|</span><span class=w> </span><span class=m>5</span>.027ms<span class=w>         </span><span class=p>|</span><span class=w> </span>36µs<span class=w>            </span><span class=p>|</span><span class=w> </span>131µs<span class=w>           </span><span class=p>|</span><span class=w> </span>300µs<span class=w>           </span><span class=p>|</span><span class=w> </span><span class=m>17309</span>.24
<a id=__codelineno-5-17 name=__codelineno-5-17 href=#__codelineno-5-17></a>📋<span class=w> </span>pod-to-pod<span class=w>      </span><span class=p>|</span><span class=w> </span>same-node<span class=w>  </span><span class=p>|</span><span class=w> </span>UDP_RR<span class=w>          </span><span class=p>|</span><span class=w> </span>10s<span class=w>             </span><span class=p>|</span><span class=w> </span>23µs<span class=w>            </span><span class=p>|</span><span class=w> </span><span class=m>36</span>.45µs<span class=w>         </span><span class=p>|</span><span class=w> </span><span class=m>6</span>.791ms<span class=w>         </span><span class=p>|</span><span class=w> </span>31µs<span class=w>            </span><span class=p>|</span><span class=w> </span>48µs<span class=w>            </span><span class=p>|</span><span class=w> </span>114µs<span class=w>           </span><span class=p>|</span><span class=w> </span><span class=m>27297</span>.16
<a id=__codelineno-5-18 name=__codelineno-5-18 href=#__codelineno-5-18></a>📋<span class=w> </span>pod-to-pod<span class=w>      </span><span class=p>|</span><span class=w> </span>same-node<span class=w>  </span><span class=p>|</span><span class=w> </span>TCP_CRR<span class=w>         </span><span class=p>|</span><span class=w> </span>10s<span class=w>             </span><span class=p>|</span><span class=w> </span>109µs<span class=w>           </span><span class=p>|</span><span class=w> </span><span class=m>152</span>.48µs<span class=w>        </span><span class=p>|</span><span class=w> </span><span class=m>7</span>.509ms<span class=w>         </span><span class=p>|</span><span class=w> </span>129µs<span class=w>           </span><span class=p>|</span><span class=w> </span>189µs<span class=w>           </span><span class=p>|</span><span class=w> </span>480µs<span class=w>           </span><span class=p>|</span><span class=w> </span><span class=m>6543</span>.34
<a id=__codelineno-5-19 name=__codelineno-5-19 href=#__codelineno-5-19></a>📋<span class=w> </span>pod-to-pod<span class=w>      </span><span class=p>|</span><span class=w> </span>other-node<span class=w> </span><span class=p>|</span><span class=w> </span>TCP_RR<span class=w>          </span><span class=p>|</span><span class=w> </span>10s<span class=w>             </span><span class=p>|</span><span class=w> </span>534µs<span class=w>           </span><span class=p>|</span><span class=w> </span><span class=m>1</span>.53132ms<span class=w>       </span><span class=p>|</span><span class=w> </span><span class=m>14</span>.486ms<span class=w>        </span><span class=p>|</span><span class=w> </span><span class=m>1</span>.5ms<span class=w>           </span><span class=p>|</span><span class=w> </span><span class=m>1</span>.72ms<span class=w>          </span><span class=p>|</span><span class=w> </span><span class=m>3</span>.375ms<span class=w>         </span><span class=p>|</span><span class=w> </span><span class=m>651</span>.44
<a id=__codelineno-5-20 name=__codelineno-5-20 href=#__codelineno-5-20></a>📋<span class=w> </span>pod-to-pod<span class=w>      </span><span class=p>|</span><span class=w> </span>other-node<span class=w> </span><span class=p>|</span><span class=w> </span>UDP_RR<span class=w>          </span><span class=p>|</span><span class=w> </span>10s<span class=w>             </span><span class=p>|</span><span class=w> </span>620µs<span class=w>           </span><span class=p>|</span><span class=w> </span><span class=m>1</span>.73095ms<span class=w>       </span><span class=p>|</span><span class=w> </span><span class=m>16</span>.413ms<span class=w>        </span><span class=p>|</span><span class=w> </span><span class=m>1</span>.654ms<span class=w>         </span><span class=p>|</span><span class=w> </span><span class=m>1</span>.934ms<span class=w>         </span><span class=p>|</span><span class=w> </span><span class=m>5</span>.8ms<span class=w>           </span><span class=p>|</span><span class=w> </span><span class=m>576</span>.52
<a id=__codelineno-5-21 name=__codelineno-5-21 href=#__codelineno-5-21></a>📋<span class=w> </span>pod-to-pod<span class=w>      </span><span class=p>|</span><span class=w> </span>other-node<span class=w> </span><span class=p>|</span><span class=w> </span>TCP_CRR<span class=w>         </span><span class=p>|</span><span class=w> </span>10s<span class=w>             </span><span class=p>|</span><span class=w> </span><span class=m>1</span>.748ms<span class=w>         </span><span class=p>|</span><span class=w> </span><span class=m>4</span>.96712ms<span class=w>       </span><span class=p>|</span><span class=w> </span><span class=m>19</span>.845ms<span class=w>        </span><span class=p>|</span><span class=w> </span><span class=m>4</span>.85ms<span class=w>          </span><span class=p>|</span><span class=w> </span><span class=m>6</span>.576ms<span class=w>         </span><span class=p>|</span><span class=w> </span><span class=m>10</span>.2ms<span class=w>          </span><span class=p>|</span><span class=w> </span><span class=m>201</span>.16
<a id=__codelineno-5-22 name=__codelineno-5-22 href=#__codelineno-5-22></a>--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
<a id=__codelineno-5-23 name=__codelineno-5-23 href=#__codelineno-5-23></a>-------------------------------------------------------------------------------------
<a id=__codelineno-5-24 name=__codelineno-5-24 href=#__codelineno-5-24></a>📋<span class=w> </span>Scenario<span class=w>        </span><span class=p>|</span><span class=w> </span>Node<span class=w>       </span><span class=p>|</span><span class=w> </span>Test<span class=w>            </span><span class=p>|</span><span class=w> </span>Duration<span class=w>        </span><span class=p>|</span><span class=w> </span>Throughput<span class=w> </span>Mb/s
<a id=__codelineno-5-25 name=__codelineno-5-25 href=#__codelineno-5-25></a>-------------------------------------------------------------------------------------
<a id=__codelineno-5-26 name=__codelineno-5-26 href=#__codelineno-5-26></a>📋<span class=w> </span>pod-to-pod<span class=w>      </span><span class=p>|</span><span class=w> </span>same-node<span class=w>  </span><span class=p>|</span><span class=w> </span>TCP_STREAM<span class=w>      </span><span class=p>|</span><span class=w> </span>10s<span class=w>             </span><span class=p>|</span><span class=w> </span><span class=m>1093</span>.77
<a id=__codelineno-5-27 name=__codelineno-5-27 href=#__codelineno-5-27></a>📋<span class=w> </span>pod-to-pod<span class=w>      </span><span class=p>|</span><span class=w> </span>same-node<span class=w>  </span><span class=p>|</span><span class=w> </span>UDP_STREAM<span class=w>      </span><span class=p>|</span><span class=w> </span>10s<span class=w>             </span><span class=p>|</span><span class=w> </span><span class=m>1245</span>.94
<a id=__codelineno-5-28 name=__codelineno-5-28 href=#__codelineno-5-28></a>📋<span class=w> </span>pod-to-pod<span class=w>      </span><span class=p>|</span><span class=w> </span>other-node<span class=w> </span><span class=p>|</span><span class=w> </span>TCP_STREAM<span class=w>      </span><span class=p>|</span><span class=w> </span>10s<span class=w>             </span><span class=p>|</span><span class=w> </span><span class=m>837</span>.18
<a id=__codelineno-5-29 name=__codelineno-5-29 href=#__codelineno-5-29></a>📋<span class=w> </span>pod-to-pod<span class=w>      </span><span class=p>|</span><span class=w> </span>other-node<span class=w> </span><span class=p>|</span><span class=w> </span>UDP_STREAM<span class=w>      </span><span class=p>|</span><span class=w> </span>10s<span class=w>             </span><span class=p>|</span><span class=w> </span><span class=m>323</span>.12
<a id=__codelineno-5-30 name=__codelineno-5-30 href=#__codelineno-5-30></a>-------------------------------------------------------------------------------------
</code></pre></div> <h3 id=hubble_1>Hubble</h3> <p>Observability is provided by <strong>Hubble</strong> which enables deep visibility into the communication and behavior of services as well as the networking infrastructure in a completely transparent manner.</p> <p>By default, <strong>Hubble API</strong> operates within the scope of the individual node on which the Cilium agent runs. This confines the network insights to the traffic observed by the local Cilium agent. Hubble CLI (<code>hubble</code>) can be used to query the Hubble API provided via a local Unix Domain Socket. The Hubble CLI binary is installed by default on Cilium agent pods.</p> <p>Upon deploying <strong>Hubble Relay</strong>, network visibility is provided for the entire cluster or even multiple clusters in a ClusterMesh scenario. In this mode, Hubble data can be accessed by directing Hubble CLI (<code>hubble</code>) to the Hubble Relay service or via Hubble UI. Hubble UI is a web interface which enables automatic discovery of the services dependency graph at the L3/L4 and even L7 layer, allowing user-friendly visualization and filtering of data flows as a service map.</p> <p>First you will need to install <code>hubble relay</code> and <code>hubble ui</code> into Kubernetes.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Cilium installer allows to configure <code>hubble</code> service with TLS, metrics, port and other features.</p> </div> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=c1># Cilium must be installed previously in order to be install new features from cli</span>
<a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a>
<a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=c1># Using cilium cli (without ui)</span>
<a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a>cilium<span class=w> </span>hubble<span class=w> </span><span class=nb>enable</span>
<a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>
<a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=c1># Enable cilium with ui (hubble must be disabled)</span>
<a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a>cilium<span class=w> </span>hubble<span class=w> </span><span class=nb>enable</span><span class=w> </span>--ui
<a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a>
<a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a><span class=c1>#Updated helm by enabling specific hubble features.</span>
<a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a>helm<span class=w> </span>upgrade<span class=w> </span>cilium<span class=w> </span>cilium/cilium<span class=w> </span>--version<span class=w> </span><span class=m>1</span>.15.3<span class=w> </span><span class=se>\</span>
<a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a><span class=w>   </span>--namespace<span class=w> </span>kube-system<span class=w> </span><span class=se>\</span>
<a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a><span class=w>   </span>--reuse-values<span class=w> </span><span class=se>\</span>
<a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a><span class=w>   </span>--set<span class=w> </span>hubble.relay.enabled<span class=o>=</span><span class=nb>true</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a><span class=w>   </span>--set<span class=w> </span>hubble.ui.enabled<span class=o>=</span><span class=nb>true</span>
</code></pre></div> <p>Install <code>hubble</code> cli to interact with Hubble API for observability and troubleshooting.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=c1># Install hubble using homebrew</span>
<a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a>brew<span class=w> </span>install<span class=w> </span>hubble
</code></pre></div> <p>Validate the hubble installation</p> <div class=highlight><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=c1># Expose the Hubble API by using Port forward on port :4245</span>
<a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a>cilium<span class=w> </span>hubble<span class=w> </span>port-forward<span class=w> </span>-n<span class=w> </span>networking
<a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a>
<a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=c1># In another terminal use following command to test the hubble status</span>
<a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a>hubble<span class=w> </span>status
<a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a>
<a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a><span class=c1># List all nodes</span>
<a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a>hubble<span class=w> </span>list<span class=w> </span>nodes
<a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a>
<a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a>NAME<span class=w>       </span>STATUS<span class=w>      </span>AGE<span class=w>       </span>FLOWS/S<span class=w>   </span>CURRENT/MAX-FLOWS
<a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a>server-1<span class=w>   </span>Connected<span class=w>   </span>5h7m50s<span class=w>   </span><span class=m>14</span>.09<span class=w>     </span><span class=m>4095</span>/4095<span class=w> </span><span class=o>(</span><span class=m>100</span>.00%<span class=o>)</span>
<a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a>server-2<span class=w>   </span>Connected<span class=w>   </span>5h7m56s<span class=w>   </span><span class=m>19</span>.43<span class=w>     </span><span class=m>4095</span>/4095<span class=w> </span><span class=o>(</span><span class=m>100</span>.00%<span class=o>)</span>
<a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a>server-3<span class=w>   </span>Connected<span class=w>   </span>5h7m49s<span class=w>   </span><span class=m>14</span>.04<span class=w>     </span><span class=m>4095</span>/4095<span class=w> </span><span class=o>(</span><span class=m>100</span>.00%<span class=o>)</span>
<a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a>
<a id=__codelineno-8-15 name=__codelineno-8-15 href=#__codelineno-8-15></a><span class=c1># You can also query the flow API and look for flows</span>
<a id=__codelineno-8-16 name=__codelineno-8-16 href=#__codelineno-8-16></a>hubble<span class=w> </span>observe
</code></pre></div> <p>Open the Hubble UI using cilium cli</p> <div class=highlight><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=c1># Use following command for port forwarding (port 12000)</span>
<a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a>cilium<span class=w> </span>hubble<span class=w> </span>ui<span class=w> </span>-n<span class=w> </span>networking
<a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a>
<a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=c1># Run the cilium test to get some traffic (different terminal)</span>
<a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a><span class=k>while</span><span class=w> </span>true<span class=p>;</span><span class=w> </span><span class=k>do</span><span class=w> </span>cilium<span class=w> </span>connectivity<span class=w> </span><span class=nb>test</span><span class=w> </span>-n<span class=w> </span>networking<span class=p>;</span><span class=w> </span><span class=k>done</span>
<a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a>
<a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a><span class=c1># http://localhost:12000/</span>
</code></pre></div> <h2 id=demo>Demo</h2> <p>In the Star Wars-inspired example from Cilium, there are three microservices applications: <code>deathstar</code>, <code>tiefighter</code>, and <code>xwing</code>.</p> <ul> <li>The <code>deathstar</code> runs an HTTP webservice on port 80, which is exposed as a Kubernetes <code>Service</code> to load-balance requests to <code>deathstar</code> across two pod replicas. The deathstar service provides landing services to the empire's spaceships so that they can request a landing port.</li> <li>The <code>tiefighter</code> pod represents a landing-request client service on a typical <code>empire</code> ship.</li> <li>The <code>xwing</code> represents a similar service on an <code>alliance</code> ship.</li> </ul> <p><a class=glightbox href=../../../images/cilium_http_gsg.webp data-type=image data-width=100% data-height=auto data-desc-position=bottom><img alt="Star Wars-inspired demo" src=../../../images/cilium_http_gsg.webp></a></p> <p>They exist so that we can test different <strong>security policies</strong> for access control to deathstar landing services.</p> <h3 id=deployment>Deployment</h3> <p>The file <code>http-sw-app.yaml</code> contains a Kubernetes Deployment for each of the three services. Each deployment is identified using the Kubernetes labels (<code>org=empire, class=deathstar</code>), (<code>org=empire, class=tiefighter</code>), and (<code>org=alliance, class=xwing</code>). It also includes a <code>deathstar-service</code>, which load-balances traffic to all pods with label (<code>org=empire, class=deathstar</code>).</p> <p>This is an example of the <code>deathstar</code> deployment with the labels <code>org=empire, class=deathstar</code>.</p> <div class=highlight><span class=filename>http-sw-app.yaml</span><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">deathstar</span>
<a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a><span class=w>  </span><span class=nt>labels</span><span class=p>:</span>
<a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a><span class=w>    </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">deathstar</span>
<a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<a id=__codelineno-10-9 name=__codelineno-10-9 href=#__codelineno-10-9></a><span class=w>  </span><span class=nt>selector</span><span class=p>:</span>
<a id=__codelineno-10-10 name=__codelineno-10-10 href=#__codelineno-10-10></a><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span>
<a id=__codelineno-10-11 name=__codelineno-10-11 href=#__codelineno-10-11></a><span class=w>      </span><span class=nt>org</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">empire</span>
<a id=__codelineno-10-12 name=__codelineno-10-12 href=#__codelineno-10-12></a><span class=w>      </span><span class=nt>class</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">deathstar</span>
<a id=__codelineno-10-13 name=__codelineno-10-13 href=#__codelineno-10-13></a><span class=w>  </span><span class=nt>template</span><span class=p>:</span>
<a id=__codelineno-10-14 name=__codelineno-10-14 href=#__codelineno-10-14></a><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-10-15 name=__codelineno-10-15 href=#__codelineno-10-15></a><span class=w>      </span><span class=nt>labels</span><span class=p>:</span>
<a id=__codelineno-10-16 name=__codelineno-10-16 href=#__codelineno-10-16></a><span class=hll><span class=w>        </span><span class=nt>org</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">empire</span>
</span><a id=__codelineno-10-17 name=__codelineno-10-17 href=#__codelineno-10-17></a><span class=hll><span class=w>        </span><span class=nt>class</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">deathstar</span>
</span><a id=__codelineno-10-18 name=__codelineno-10-18 href=#__codelineno-10-18></a><span class=w>        </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">deathstar</span>
<a id=__codelineno-10-19 name=__codelineno-10-19 href=#__codelineno-10-19></a><span class=w>    </span><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-10-20 name=__codelineno-10-20 href=#__codelineno-10-20></a><span class=w>      </span><span class=nt>containers</span><span class=p>:</span>
<a id=__codelineno-10-21 name=__codelineno-10-21 href=#__codelineno-10-21></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">deathstar</span>
<a id=__codelineno-10-22 name=__codelineno-10-22 href=#__codelineno-10-22></a><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">quay.io/cilium/starwars:v2.1@sha256:833d915ec68fca3ce83668fc5dae97c455b2134d8f23ef96586f55b894cfb1e8</span>
</code></pre></div> <div class=highlight><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=c1># Deploy the base demo resources into default namespace</span>
<a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>https://raw.githubusercontent.com/jsa4000/homelab-ops/main/docs/_source/layers/networking/cilium/http-sw-app.yaml
<a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a>
<a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a>service/deathstar<span class=w> </span>created
<a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a>deployment.apps/deathstar<span class=w> </span>created
<a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a>pod/tiefighter<span class=w> </span>created
<a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a>pod/xwing<span class=w> </span>created
<a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a>
<a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a><span class=c1># Get resources deployeed</span>
<a id=__codelineno-11-10 name=__codelineno-11-10 href=#__codelineno-11-10></a>kubectl<span class=w> </span>get,services<span class=w> </span>pods
<a id=__codelineno-11-11 name=__codelineno-11-11 href=#__codelineno-11-11></a>
<a id=__codelineno-11-12 name=__codelineno-11-12 href=#__codelineno-11-12></a><span class=c1># Check the pod statuses</span>
<a id=__codelineno-11-13 name=__codelineno-11-13 href=#__codelineno-11-13></a>kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>-w
</code></pre></div> <p>Each <code>pod</code> will be represented in Cilium as an <code>Endpoint</code> in the local cilium agent. We can invoke the cilium tool inside the Cilium pod to list them (in a single-node installation <code>kubectl -n networking exec ds/cilium -- cilium-dbg endpoint list</code> lists them all, but in a multi-node installation, only the ones running on the same node will be listed)</p> <p>Get the ingress and egress enforcements policies with the identities and labels assigned by cilium currently applied to these pods/endpoints.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=c1># List all endpoints (pods) available in the current node (each agent manage it&#39;s own pods)</span>
<a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a>kubectl<span class=w> </span>-n<span class=w> </span>networking<span class=w> </span><span class=nb>exec</span><span class=w> </span>ds/cilium<span class=w> </span>--<span class=w> </span>cilium-dbg<span class=w> </span>endpoint<span class=w> </span>list
<a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a>
<a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a>Defaulted<span class=w> </span>container<span class=w> </span><span class=s2>&quot;cilium-agent&quot;</span><span class=w> </span>out<span class=w> </span>of:<span class=w> </span>cilium-agent,<span class=w> </span>config<span class=w> </span><span class=o>(</span>init<span class=o>)</span>,<span class=w> </span>mount-cgroup<span class=w> </span><span class=o>(</span>init<span class=o>)</span>,<span class=w> </span>apply-sysctl-overwrites<span class=w> </span><span class=o>(</span>init<span class=o>)</span>,<span class=w> </span>mount-bpf-fs<span class=w> </span><span class=o>(</span>init<span class=o>)</span>,<span class=w> </span>clean-cilium-state<span class=w> </span><span class=o>(</span>init<span class=o>)</span>,<span class=w> </span>install-cni-binaries<span class=w> </span><span class=o>(</span>init<span class=o>)</span>
<a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a>ENDPOINT<span class=w>   </span>POLICY<span class=w> </span><span class=o>(</span>ingress<span class=o>)</span><span class=w>   </span>POLICY<span class=w> </span><span class=o>(</span>egress<span class=o>)</span><span class=w>   </span>IDENTITY<span class=w>   </span>LABELS<span class=w> </span><span class=o>(</span>source:key<span class=o>[=</span>value<span class=o>])</span><span class=w>                                              </span>IPv6<span class=w>   </span>IPv4<span class=w>          </span>STATUS
<a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a><span class=w>           </span>ENFORCEMENT<span class=w>        </span>ENFORCEMENT
<a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a>
<a id=__codelineno-12-8 name=__codelineno-12-8 href=#__codelineno-12-8></a><span class=m>1453</span><span class=w>       </span>Disabled<span class=w>           </span>Disabled<span class=w>          </span><span class=m>45221</span><span class=w>      </span>k8s:app.kubernetes.io/name<span class=o>=</span>deathstar<span class=w>                                            </span><span class=m>10</span>.52.1.208<span class=w>   </span>ready
<a id=__codelineno-12-9 name=__codelineno-12-9 href=#__codelineno-12-9></a><span class=w>                                                           </span>k8s:class<span class=o>=</span>deathstar
<a id=__codelineno-12-10 name=__codelineno-12-10 href=#__codelineno-12-10></a><span class=w>                                                           </span>k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name<span class=o>=</span>default
<a id=__codelineno-12-11 name=__codelineno-12-11 href=#__codelineno-12-11></a><span class=w>                                                           </span>k8s:io.cilium.k8s.policy.cluster<span class=o>=</span>default
<a id=__codelineno-12-12 name=__codelineno-12-12 href=#__codelineno-12-12></a><span class=w>                                                           </span>k8s:io.cilium.k8s.policy.serviceaccount<span class=o>=</span>default
<a id=__codelineno-12-13 name=__codelineno-12-13 href=#__codelineno-12-13></a><span class=w>                                                           </span>k8s:io.kubernetes.pod.namespace<span class=o>=</span>default
<a id=__codelineno-12-14 name=__codelineno-12-14 href=#__codelineno-12-14></a><span class=w>                                                           </span>k8s:org<span class=o>=</span>empire
<a id=__codelineno-12-15 name=__codelineno-12-15 href=#__codelineno-12-15></a>
<a id=__codelineno-12-16 name=__codelineno-12-16 href=#__codelineno-12-16></a><span class=c1># This information can be also gotten from CRD (ciliumnetworkpolicy or cnp)</span>
<a id=__codelineno-12-17 name=__codelineno-12-17 href=#__codelineno-12-17></a>kubectl<span class=w> </span>get<span class=w> </span>cep
<a id=__codelineno-12-18 name=__codelineno-12-18 href=#__codelineno-12-18></a>kubectl<span class=w> </span>get<span class=w> </span>cep<span class=w> </span>-o<span class=w> </span>wide
<a id=__codelineno-12-19 name=__codelineno-12-19 href=#__codelineno-12-19></a>
<a id=__codelineno-12-20 name=__codelineno-12-20 href=#__codelineno-12-20></a>NAME<span class=w>                        </span>SECURITY<span class=w> </span>IDENTITY<span class=w>   </span>INGRESS<span class=w> </span>ENFORCEMENT<span class=w>   </span>EGRESS<span class=w> </span>ENFORCEMENT<span class=w>   </span>VISIBILITY<span class=w> </span>POLICY<span class=w>   </span>ENDPOINT<span class=w> </span>STATE<span class=w>   </span>IPV4<span class=w>          </span>IPV6
<a id=__codelineno-12-21 name=__codelineno-12-21 href=#__codelineno-12-21></a>deathstar-b4b8ccfb5-w84sn<span class=w>   </span><span class=m>6822</span><span class=w>                </span>&lt;status<span class=w> </span>disabled&gt;<span class=w>     </span>&lt;status<span class=w> </span>disabled&gt;<span class=w>    </span>&lt;status<span class=w> </span>disabled&gt;<span class=w>   </span>ready<span class=w>            </span><span class=m>10</span>.52.1.239
<a id=__codelineno-12-22 name=__codelineno-12-22 href=#__codelineno-12-22></a>deathstar-b4b8ccfb5-f75xw<span class=w>   </span><span class=m>6822</span><span class=w>                </span>&lt;status<span class=w> </span>disabled&gt;<span class=w>     </span>&lt;status<span class=w> </span>disabled&gt;<span class=w>    </span>&lt;status<span class=w> </span>disabled&gt;<span class=w>   </span>ready<span class=w>            </span><span class=m>10</span>.52.2.36
<a id=__codelineno-12-23 name=__codelineno-12-23 href=#__codelineno-12-23></a>tiefighter<span class=w>                  </span><span class=m>25698</span><span class=w>               </span>&lt;status<span class=w> </span>disabled&gt;<span class=w>     </span>&lt;status<span class=w> </span>disabled&gt;<span class=w>    </span>&lt;status<span class=w> </span>disabled&gt;<span class=w>   </span>ready<span class=w>            </span><span class=m>10</span>.52.2.26
<a id=__codelineno-12-24 name=__codelineno-12-24 href=#__codelineno-12-24></a>xwing<span class=w>                       </span><span class=m>63406</span><span class=w>               </span>&lt;status<span class=w> </span>disabled&gt;<span class=w>     </span>&lt;status<span class=w> </span>disabled&gt;<span class=w>    </span>&lt;status<span class=w> </span>disabled&gt;<span class=w>   </span>ready<span class=w>            </span><span class=m>10</span>.52.1.220
</code></pre></div> <h3 id=check-current-access>Check Current Access</h3> <p>From the perspective of the <code>deathstar</code> service, only the ships with label <code>org=empire</code> are allowed to connect and request landing. Since we have no rules enforced, both <code>xwing</code> and <code>tiefighter</code> will be able to request landing. To test this, use the commands below.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=c1># Check connectivity between xwing and deathstar</span>
<a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>xwing<span class=w> </span>--<span class=w> </span>curl<span class=w> </span>-s<span class=w> </span>-XPOST<span class=w> </span>deathstar.default.svc.cluster.local/v1/request-landing
<a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a>Ship<span class=w> </span>landed
<a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a>
<a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a><span class=c1># Check connectivity between tiefighter and deathstar</span>
<a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>tiefighter<span class=w> </span>--<span class=w> </span>curl<span class=w> </span>-s<span class=w> </span>-XPOST<span class=w> </span>deathstar.default.svc.cluster.local/v1/request-landing
<a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a>Ship<span class=w> </span>landed
</code></pre></div> <h3 id=apply-an-l3l4-policy>Apply an L3/L4 Policy</h3> <p>When using Cilium, endpoint <em>IP addresses</em> are <strong>irrelevant</strong> when defining security policies. Instead, you can use the <strong>labels</strong> assigned to the pods to define security policies. The policies will be applied to the right <code>pods</code> based on the labels irrespective of where or when it is running within the cluster.</p> <p>We'll start with the basic policy restricting deathstar landing requests to only the ships that have label (<code>org=empire</code>). This will not allow any ships that don't have the <code>org=empire</code> label to even connect with the deathstar service. This is a simple policy that filters only on IP protocol (<code>network layer 3</code>) and TCP protocol (<code>network layer 4</code>), so it is often referred to as an <strong>L3/L4 network security policy</strong>.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Once a <code>NetworkPolicy</code> has been applied it <strong>denies</strong> automatically the connections that do not satisfied this policy. It's recommended to set a <strong>Zero Trust Security</strong> policy at a cluster level to deny every connection and start adding Network Policies to enable the <strong>trusted</strong> connections.</p> <p>The <code>CiliumNetworkPolicy</code> is an upgrade from the standard kubernetes <code>NetworkPolicy</code>. There are two flavours of <code>NetworkPolicies</code> in Cilium, <code>CiliumNetworkPolicy</code> and <code>CiliumClusterwideNetworkPolicy</code>. There are a couple of things you can't do with the <code>NetworkPolicy</code> resource:</p> <ul> <li>You can't use L7 rules - for example, you can't use HTTP methods, headers, or paths in your policies.</li> <li>Anything TLS related</li> <li>You can't write node-specific policies</li> <li>You can't write deny policies and more</li> </ul> </div> <p><a class=glightbox href=../../../images/cilium_http_l3_l4_gsg.png data-type=image data-width=100% data-height=auto data-desc-position=bottom><img alt="Star Wars-inspired demo" src=../../../images/cilium_http_l3_l4_gsg.png></a></p> <p>This <strong>Endpoint Based</strong> Policy will restrict any <code>ingress</code> network connections to <code>endpoints</code> (<code>pods</code>) with labels <code>class: deathstar</code> and <code>org: empire</code>, so it only allows incoming traffic from <code>endpoints</code> with labels <code>org=empire</code> on port <code>80</code>.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>The layer 3 policy establishes the base connectivity rules regarding which endpoints can talk to each other. Layer 3 policies can be specified using the following methods: <strong>Endpoints Based</strong>, <strong>Services based</strong>, <strong>Entities Based</strong>, <strong>IP/CIDR based</strong> and <strong>DNS based</strong>. Check this <a href=https://docs.cilium.io/en/latest/security/policy/language/ >link</a> for more documentation.</p> </div> <div class=highlight><span class=filename>sw_l3_l4_policy_endpoint.yaml</span><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=s>&quot;cilium.io/v2&quot;</span>
<a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">CiliumNetworkPolicy</span>
<a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;rule1&quot;</span>
<a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a><span class=w>  </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s>&quot;L3-L4</span><span class=nv> </span><span class=s>policy</span><span class=nv> </span><span class=s>to</span><span class=nv> </span><span class=s>restrict</span><span class=nv> </span><span class=s>deathstar</span><span class=nv> </span><span class=s>access</span><span class=nv> </span><span class=s>to</span><span class=nv> </span><span class=s>empire</span><span class=nv> </span><span class=s>ships</span><span class=nv> </span><span class=s>only&quot;</span>
<a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a><span class=w>  </span><span class=nt>endpointSelector</span><span class=p>:</span>
<a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span>
<a id=__codelineno-14-9 name=__codelineno-14-9 href=#__codelineno-14-9></a><span class=hll><span class=w>      </span><span class=nt>org</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">empire</span>
</span><a id=__codelineno-14-10 name=__codelineno-14-10 href=#__codelineno-14-10></a><span class=hll><span class=w>      </span><span class=nt>class</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">deathstar</span>
</span><a id=__codelineno-14-11 name=__codelineno-14-11 href=#__codelineno-14-11></a><span class=w>  </span><span class=nt>ingress</span><span class=p>:</span>
<a id=__codelineno-14-12 name=__codelineno-14-12 href=#__codelineno-14-12></a><span class=hll><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>fromEndpoints</span><span class=p>:</span>
</span><a id=__codelineno-14-13 name=__codelineno-14-13 href=#__codelineno-14-13></a><span class=hll><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>matchLabels</span><span class=p>:</span>
</span><a id=__codelineno-14-14 name=__codelineno-14-14 href=#__codelineno-14-14></a><span class=hll><span class=w>            </span><span class=nt>org</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">empire</span>
</span><a id=__codelineno-14-15 name=__codelineno-14-15 href=#__codelineno-14-15></a><span class=w>      </span><span class=nt>toPorts</span><span class=p>:</span>
<a id=__codelineno-14-16 name=__codelineno-14-16 href=#__codelineno-14-16></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>ports</span><span class=p>:</span>
<a id=__codelineno-14-17 name=__codelineno-14-17 href=#__codelineno-14-17></a><span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=s>&quot;80&quot;</span>
<a id=__codelineno-14-18 name=__codelineno-14-18 href=#__codelineno-14-18></a><span class=w>              </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
</code></pre></div> <div class=highlight><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=c1># Create CiliumNetworkPolicy resource</span>
<a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>https://raw.githubusercontent.com/jsa4000/homelab-ops/main/docs/_source/layers/networking/cilium/sw_l3_l4_policy.yaml
<a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a>
<a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a><span class=c1># This information can be also gotten from CRD (ciliumnetworkpolicy or cnp)</span>
<a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a>kubectl<span class=w> </span>get<span class=w> </span>cnp
<a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a>
<a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a><span class=c1># Delete the policy to return to previous state</span>
<a id=__codelineno-15-8 name=__codelineno-15-8 href=#__codelineno-15-8></a>kubectl<span class=w> </span>delete<span class=w> </span>cnp<span class=w> </span>rule1
</code></pre></div> <p>Instead a Service Based policiy can also be applied to enforce network traffic that goes from an endpoint to a specific services or endpoints (<code>egress</code>).</p> <div class=highlight><span class=filename>sw_l3_l4_policy_service.yaml</span><pre><span></span><code><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=s>&quot;cilium.io/v2&quot;</span>
<a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">CiliumNetworkPolicy</span>
<a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;rule1&quot;</span>
<a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a><span class=w>  </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s>&quot;L3-L4</span><span class=nv> </span><span class=s>policy</span><span class=nv> </span><span class=s>to</span><span class=nv> </span><span class=s>restrict</span><span class=nv> </span><span class=s>tiefighter</span><span class=nv> </span><span class=s>ship</span><span class=nv> </span><span class=s>access</span><span class=nv> </span><span class=s>to</span><span class=nv> </span><span class=s>deathstar</span><span class=nv> </span><span class=s>only&quot;</span>
<a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a><span class=w>  </span><span class=nt>endpointSelector</span><span class=p>:</span>
<a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span>
<a id=__codelineno-16-9 name=__codelineno-16-9 href=#__codelineno-16-9></a><span class=hll><span class=w>      </span><span class=nt>org</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">empire</span>
</span><a id=__codelineno-16-10 name=__codelineno-16-10 href=#__codelineno-16-10></a><span class=hll><span class=w>      </span><span class=nt>class</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">tiefighter</span>
</span><a id=__codelineno-16-11 name=__codelineno-16-11 href=#__codelineno-16-11></a><span class=w>  </span><span class=nt>ingress</span><span class=p>:</span>
<a id=__codelineno-16-12 name=__codelineno-16-12 href=#__codelineno-16-12></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="p p-Indicator">{}</span>
<a id=__codelineno-16-13 name=__codelineno-16-13 href=#__codelineno-16-13></a><span class=w>  </span><span class=nt>egress</span><span class=p>:</span>
<a id=__codelineno-16-14 name=__codelineno-16-14 href=#__codelineno-16-14></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>toServices</span><span class=p>:</span>
<a id=__codelineno-16-15 name=__codelineno-16-15 href=#__codelineno-16-15></a><span class=hll><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>k8sService</span><span class=p>:</span>
</span><a id=__codelineno-16-16 name=__codelineno-16-16 href=#__codelineno-16-16></a><span class=hll><span class=w>            </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
</span><a id=__codelineno-16-17 name=__codelineno-16-17 href=#__codelineno-16-17></a><span class=hll><span class=w>            </span><span class=nt>serviceName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">deathstar</span>
</span><a id=__codelineno-16-18 name=__codelineno-16-18 href=#__codelineno-16-18></a><span class=w>      </span><span class=nt>toPorts</span><span class=p>:</span>
<a id=__codelineno-16-19 name=__codelineno-16-19 href=#__codelineno-16-19></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>ports</span><span class=p>:</span>
<a id=__codelineno-16-20 name=__codelineno-16-20 href=#__codelineno-16-20></a><span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=s>&quot;80&quot;</span>
<a id=__codelineno-16-21 name=__codelineno-16-21 href=#__codelineno-16-21></a><span class=w>              </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<a id=__codelineno-16-22 name=__codelineno-16-22 href=#__codelineno-16-22></a><span class=nn>---</span>
<a id=__codelineno-16-23 name=__codelineno-16-23 href=#__codelineno-16-23></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=s>&quot;cilium.io/v2&quot;</span>
<a id=__codelineno-16-24 name=__codelineno-16-24 href=#__codelineno-16-24></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">CiliumNetworkPolicy</span>
<a id=__codelineno-16-25 name=__codelineno-16-25 href=#__codelineno-16-25></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-16-26 name=__codelineno-16-26 href=#__codelineno-16-26></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;rule2&quot;</span>
<a id=__codelineno-16-27 name=__codelineno-16-27 href=#__codelineno-16-27></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-16-28 name=__codelineno-16-28 href=#__codelineno-16-28></a><span class=w>  </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s>&quot;L3-L4</span><span class=nv> </span><span class=s>policy</span><span class=nv> </span><span class=s>to</span><span class=nv> </span><span class=s>restrict</span><span class=nv> </span><span class=s>xwing</span><span class=nv> </span><span class=s>ship</span><span class=nv> </span><span class=s>access</span><span class=nv> </span><span class=s>to</span><span class=nv> </span><span class=s>deathstar</span><span class=nv> </span><span class=s>only&quot;</span>
<a id=__codelineno-16-29 name=__codelineno-16-29 href=#__codelineno-16-29></a><span class=w>  </span><span class=nt>endpointSelector</span><span class=p>:</span>
<a id=__codelineno-16-30 name=__codelineno-16-30 href=#__codelineno-16-30></a><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span>
<a id=__codelineno-16-31 name=__codelineno-16-31 href=#__codelineno-16-31></a><span class=hll><span class=w>      </span><span class=nt>org</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">alliance</span>
</span><a id=__codelineno-16-32 name=__codelineno-16-32 href=#__codelineno-16-32></a><span class=hll><span class=w>      </span><span class=nt>class</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">xwing</span>
</span><a id=__codelineno-16-33 name=__codelineno-16-33 href=#__codelineno-16-33></a><span class=w>  </span><span class=nt>ingress</span><span class=p>:</span>
<a id=__codelineno-16-34 name=__codelineno-16-34 href=#__codelineno-16-34></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="p p-Indicator">{}</span>
<a id=__codelineno-16-35 name=__codelineno-16-35 href=#__codelineno-16-35></a><span class=w>  </span><span class=nt>egressDeny</span><span class=p>:</span>
<a id=__codelineno-16-36 name=__codelineno-16-36 href=#__codelineno-16-36></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>toServices</span><span class=p>:</span>
<a id=__codelineno-16-37 name=__codelineno-16-37 href=#__codelineno-16-37></a><span class=hll><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>k8sService</span><span class=p>:</span>
</span><a id=__codelineno-16-38 name=__codelineno-16-38 href=#__codelineno-16-38></a><span class=hll><span class=w>            </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
</span><a id=__codelineno-16-39 name=__codelineno-16-39 href=#__codelineno-16-39></a><span class=hll><span class=w>            </span><span class=nt>serviceName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">deathstar</span>
</span><a id=__codelineno-16-40 name=__codelineno-16-40 href=#__codelineno-16-40></a><span class=w>      </span><span class=nt>toPorts</span><span class=p>:</span>
<a id=__codelineno-16-41 name=__codelineno-16-41 href=#__codelineno-16-41></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>ports</span><span class=p>:</span>
<a id=__codelineno-16-42 name=__codelineno-16-42 href=#__codelineno-16-42></a><span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=s>&quot;80&quot;</span>
<a id=__codelineno-16-43 name=__codelineno-16-43 href=#__codelineno-16-43></a><span class=w>              </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
</code></pre></div> <div class=highlight><pre><span></span><code><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=c1># Create CiliumNetworkPolicy resource</span>
<a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>https://raw.githubusercontent.com/jsa4000/homelab-ops/main/docs/_source/layers/networking/cilium/sw_l3_l4_policy_service.yaml
<a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a>
<a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a><span class=c1># This information can be also gotten from CRD (ciliumnetworkpolicy or cnp)</span>
<a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a>kubectl<span class=w> </span>get<span class=w> </span>cnp
<a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a>
<a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a><span class=c1># Delete the policy to return to previous state</span>
<a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a>kubectl<span class=w> </span>delete<span class=w> </span>cnp<span class=w> </span>rule1
<a id=__codelineno-17-9 name=__codelineno-17-9 href=#__codelineno-17-9></a>kubectl<span class=w> </span>delete<span class=w> </span>cnp<span class=w> </span>rule2
</code></pre></div> <p>Now if we run the landing requests again, only the tiefighter pods with the label <code>org=empire</code> will succeed. The xwing pods will be blocked!</p> <div class=highlight><pre><span></span><code><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=c1># tiefighter pods with the label org=empire will succeed</span>
<a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>tiefighter<span class=w> </span>--<span class=w> </span>curl<span class=w> </span>-s<span class=w> </span>-XPOST<span class=w> </span>deathstar.default.svc.cluster.local/v1/request-landing
<a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a>Ship<span class=w> </span>landed
<a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a>
<a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a><span class=c1># xwing pods with the label org!=empire will not succeed</span>
<a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>xwing<span class=w> </span>--<span class=w> </span>curl<span class=w> </span>-s<span class=w> </span>-XPOST<span class=w> </span>deathstar.default.svc.cluster.local/v1/request-landing
<a id=__codelineno-18-7 name=__codelineno-18-7 href=#__codelineno-18-7></a>
<a id=__codelineno-18-8 name=__codelineno-18-8 href=#__codelineno-18-8></a><span class=c1># Connection Hangs or Timeout</span>
</code></pre></div> <h3 id=inspecting-the-policy>Inspecting the Policy</h3> <p>If we run cilium-dbg endpoint list again we will see that the pods with the label <code>org=empire</code> and <code>class=deathstar</code> now have ingress policy enforcement <code>enabled</code> as per the policy above.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=c1># Check policy enabled on deathstar endpoint</span>
<a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a>kubectl<span class=w> </span>-n<span class=w> </span>networking<span class=w> </span><span class=nb>exec</span><span class=w> </span>ds/cilium<span class=w> </span>--<span class=w> </span>cilium-dbg<span class=w> </span>endpoint<span class=w> </span>list
<a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a>
<a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a>Defaulted<span class=w> </span>container<span class=w> </span><span class=s2>&quot;cilium-agent&quot;</span><span class=w> </span>out<span class=w> </span>of:<span class=w> </span>cilium-agent,<span class=w> </span>config<span class=w> </span><span class=o>(</span>init<span class=o>)</span>,<span class=w> </span>mount-cgroup<span class=w> </span><span class=o>(</span>init<span class=o>)</span>,<span class=w> </span>apply-sysctl-overwrites<span class=w> </span><span class=o>(</span>init<span class=o>)</span>,<span class=w> </span>mount-bpf-fs<span class=w> </span><span class=o>(</span>init<span class=o>)</span>,<span class=w> </span>clean-cilium-state<span class=w> </span><span class=o>(</span>init<span class=o>)</span>,<span class=w> </span>install-cni-binaries<span class=w> </span><span class=o>(</span>init<span class=o>)</span>
<a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a>ENDPOINT<span class=w>   </span>POLICY<span class=w> </span><span class=o>(</span>ingress<span class=o>)</span><span class=w>   </span>POLICY<span class=w> </span><span class=o>(</span>egress<span class=o>)</span><span class=w>   </span>IDENTITY<span class=w>   </span>LABELS<span class=w> </span><span class=o>(</span>source:key<span class=o>[=</span>value<span class=o>])</span><span class=w>                                              </span>IPv6<span class=w>   </span>IPv4<span class=w>          </span>STATUS
<a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a><span class=w>           </span>ENFORCEMENT<span class=w>        </span>ENFORCEMENT
<a id=__codelineno-19-7 name=__codelineno-19-7 href=#__codelineno-19-7></a>
<a id=__codelineno-19-8 name=__codelineno-19-8 href=#__codelineno-19-8></a><span class=m>1453</span><span class=w>       </span>Enabled<span class=w>            </span>Disabled<span class=w>          </span><span class=m>45221</span><span class=w>      </span>k8s:app.kubernetes.io/name<span class=o>=</span>deathstar<span class=w>                                            </span><span class=m>10</span>.52.1.208<span class=w>   </span>ready
<a id=__codelineno-19-9 name=__codelineno-19-9 href=#__codelineno-19-9></a><span class=w>                                                           </span>k8s:class<span class=o>=</span>deathstar
<a id=__codelineno-19-10 name=__codelineno-19-10 href=#__codelineno-19-10></a><span class=w>                                                           </span>k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name<span class=o>=</span>default
<a id=__codelineno-19-11 name=__codelineno-19-11 href=#__codelineno-19-11></a><span class=w>                                                           </span>k8s:io.cilium.k8s.policy.cluster<span class=o>=</span>default
<a id=__codelineno-19-12 name=__codelineno-19-12 href=#__codelineno-19-12></a><span class=w>                                                           </span>k8s:io.cilium.k8s.policy.serviceaccount<span class=o>=</span>default
<a id=__codelineno-19-13 name=__codelineno-19-13 href=#__codelineno-19-13></a><span class=w>                                                           </span>k8s:io.kubernetes.pod.namespace<span class=o>=</span>default
<a id=__codelineno-19-14 name=__codelineno-19-14 href=#__codelineno-19-14></a><span class=w>                                                           </span>k8s:org<span class=o>=</span>empire
<a id=__codelineno-19-15 name=__codelineno-19-15 href=#__codelineno-19-15></a>
<a id=__codelineno-19-16 name=__codelineno-19-16 href=#__codelineno-19-16></a><span class=c1># This information can be also gotten from CRD (ciliumnetworkpolicy or cnp)</span>
<a id=__codelineno-19-17 name=__codelineno-19-17 href=#__codelineno-19-17></a>kubectl<span class=w> </span>get<span class=w> </span>cep
<a id=__codelineno-19-18 name=__codelineno-19-18 href=#__codelineno-19-18></a>kubectl<span class=w> </span>get<span class=w> </span>cep<span class=w> </span>-o<span class=w> </span>wide
</code></pre></div> <h3 id=apply-and-test-http-aware-l7-policy>Apply and Test HTTP-aware L7 Policy</h3> <p>In the simple scenario above, it was sufficient to either give <code>tiefighter</code> / <code>xwing</code> full access to deathstar's API or no access at all. But to provide the strongest security (i.e., enforce least-privilege isolation) between microservices, each service that calls deathstar's API should be limited to making only the set of HTTP requests it requires for legitimate operation.</p> <p>For example, consider that the deathstar service exposes some maintenance APIs which should not be called by random empire ships.</p> <p><a class=glightbox href=../../../images/cilium_http_l3_l4_l7_gsg.webp data-type=image data-width=100% data-height=auto data-desc-position=bottom><img alt="L7 Policy with Cilium and Kubernetes" src=../../../images/cilium_http_l3_l4_l7_gsg.webp></a></p> <div class=highlight><pre><span></span><code><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=c1># force an error calling to /v1/exhaust-port</span>
<a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>tiefighter<span class=w> </span>--<span class=w> </span>curl<span class=w> </span>-s<span class=w> </span>-XPUT<span class=w> </span>deathstar.default.svc.cluster.local/v1/exhaust-port
<a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a>
<a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a>Panic:<span class=w> </span>deathstar<span class=w> </span>exploded
<a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a>
<a id=__codelineno-20-6 name=__codelineno-20-6 href=#__codelineno-20-6></a>goroutine<span class=w> </span><span class=m>1</span><span class=w> </span><span class=o>[</span>running<span class=o>]</span>:
<a id=__codelineno-20-7 name=__codelineno-20-7 href=#__codelineno-20-7></a>main.HandleGarbage<span class=o>(</span>0x2080c3f50,<span class=w> </span>0x2,<span class=w> </span>0x4,<span class=w> </span>0x425c0,<span class=w> </span>0x5,<span class=w> </span>0xa<span class=o>)</span>
<a id=__codelineno-20-8 name=__codelineno-20-8 href=#__codelineno-20-8></a><span class=w>        </span>/code/src/github.com/empire/deathstar/
<a id=__codelineno-20-9 name=__codelineno-20-9 href=#__codelineno-20-9></a><span class=w>        </span>temp/main.go:9<span class=w> </span>+0x64
<a id=__codelineno-20-10 name=__codelineno-20-10 href=#__codelineno-20-10></a>main.main<span class=o>()</span>
<a id=__codelineno-20-11 name=__codelineno-20-11 href=#__codelineno-20-11></a><span class=w>        </span>/code/src/github.com/empire/deathstar/
<a id=__codelineno-20-12 name=__codelineno-20-12 href=#__codelineno-20-12></a><span class=w>        </span>temp/main.go:5<span class=w> </span>+0x85
</code></pre></div> <p>Cilium is capable of enforcing HTTP-layer (i.e., L7) policies to limit what URLs the tiefighter is allowed to reach. Here is an example policy file that extends our original policy by limiting tiefighter to making only a POST /v1/request-landing API call, but disallowing all other calls (including PUT /v1/exhaust-port).</p> <div class=highlight><span class=filename>sw_l3_l4_policy_endpoint.yaml</span><pre><span></span><code><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=s>&quot;cilium.io/v2&quot;</span>
<a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">CiliumNetworkPolicy</span>
<a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;rule1&quot;</span>
<a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-21-6 name=__codelineno-21-6 href=#__codelineno-21-6></a><span class=w>  </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s>&quot;L7</span><span class=nv> </span><span class=s>policy</span><span class=nv> </span><span class=s>to</span><span class=nv> </span><span class=s>restrict</span><span class=nv> </span><span class=s>access</span><span class=nv> </span><span class=s>to</span><span class=nv> </span><span class=s>specific</span><span class=nv> </span><span class=s>HTTP</span><span class=nv> </span><span class=s>call&quot;</span>
<a id=__codelineno-21-7 name=__codelineno-21-7 href=#__codelineno-21-7></a><span class=w>  </span><span class=nt>endpointSelector</span><span class=p>:</span>
<a id=__codelineno-21-8 name=__codelineno-21-8 href=#__codelineno-21-8></a><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span>
<a id=__codelineno-21-9 name=__codelineno-21-9 href=#__codelineno-21-9></a><span class=hll><span class=w>      </span><span class=nt>org</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">empire</span>
</span><a id=__codelineno-21-10 name=__codelineno-21-10 href=#__codelineno-21-10></a><span class=hll><span class=w>      </span><span class=nt>class</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">deathstar</span>
</span><a id=__codelineno-21-11 name=__codelineno-21-11 href=#__codelineno-21-11></a><span class=w>  </span><span class=nt>ingress</span><span class=p>:</span>
<a id=__codelineno-21-12 name=__codelineno-21-12 href=#__codelineno-21-12></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>fromEndpoints</span><span class=p>:</span>
<a id=__codelineno-21-13 name=__codelineno-21-13 href=#__codelineno-21-13></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>matchLabels</span><span class=p>:</span>
<a id=__codelineno-21-14 name=__codelineno-21-14 href=#__codelineno-21-14></a><span class=hll><span class=w>            </span><span class=nt>org</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">empire</span>
</span><a id=__codelineno-21-15 name=__codelineno-21-15 href=#__codelineno-21-15></a><span class=w>      </span><span class=nt>toPorts</span><span class=p>:</span>
<a id=__codelineno-21-16 name=__codelineno-21-16 href=#__codelineno-21-16></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>ports</span><span class=p>:</span>
<a id=__codelineno-21-17 name=__codelineno-21-17 href=#__codelineno-21-17></a><span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=s>&quot;80&quot;</span>
<a id=__codelineno-21-18 name=__codelineno-21-18 href=#__codelineno-21-18></a><span class=w>              </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<a id=__codelineno-21-19 name=__codelineno-21-19 href=#__codelineno-21-19></a><span class=w>          </span><span class=nt>rules</span><span class=p>:</span>
<a id=__codelineno-21-20 name=__codelineno-21-20 href=#__codelineno-21-20></a><span class=w>            </span><span class=nt>http</span><span class=p>:</span>
<a id=__codelineno-21-21 name=__codelineno-21-21 href=#__codelineno-21-21></a><span class=w>              </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>method</span><span class=p>:</span><span class=w> </span><span class=s>&quot;POST&quot;</span>
<a id=__codelineno-21-22 name=__codelineno-21-22 href=#__codelineno-21-22></a><span class=w>                </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s>&quot;/v1/request-landing&quot;</span>
</code></pre></div> <p>Update the existing rule to apply L7-aware policy to protect deathstar using.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=c1># Create CiliumNetworkPolicy resource</span>
<a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>https://raw.githubusercontent.com/jsa4000/homelab-ops/main/docs/_source/layers/networking/cilium/sw_l3_l4_l7_policy.yaml
</code></pre></div> <p>We can now re-run the same test as above, but we will see a different outcome.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=c1># Connection successful</span>
<a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>tiefighter<span class=w> </span>--<span class=w> </span>curl<span class=w> </span>-s<span class=w> </span>-XPOST<span class=w> </span>deathstar.default.svc.cluster.local/v1/request-landing
<a id=__codelineno-23-3 name=__codelineno-23-3 href=#__codelineno-23-3></a>Ship<span class=w> </span>landed
<a id=__codelineno-23-4 name=__codelineno-23-4 href=#__codelineno-23-4></a>
<a id=__codelineno-23-5 name=__codelineno-23-5 href=#__codelineno-23-5></a><span class=c1># Access denied because L7 Policy</span>
<a id=__codelineno-23-6 name=__codelineno-23-6 href=#__codelineno-23-6></a>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>tiefighter<span class=w> </span>--<span class=w> </span>curl<span class=w> </span>-s<span class=w> </span>-XPUT<span class=w> </span>deathstar.default.svc.cluster.local/v1/exhaust-port
<a id=__codelineno-23-7 name=__codelineno-23-7 href=#__codelineno-23-7></a>Access<span class=w> </span>denied
<a id=__codelineno-23-8 name=__codelineno-23-8 href=#__codelineno-23-8></a>
<a id=__codelineno-23-9 name=__codelineno-23-9 href=#__codelineno-23-9></a><span class=c1># Connection Failed because L3-L4 Policy</span>
<a id=__codelineno-23-10 name=__codelineno-23-10 href=#__codelineno-23-10></a>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>xwing<span class=w> </span>--<span class=w> </span>curl<span class=w> </span>-s<span class=w> </span>-XPOST<span class=w> </span>deathstar.default.svc.cluster.local/v1/request-landing
</code></pre></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>As you can see, with Cilium L7 security policies, we are able to permit <code>tiefighter</code> to access only the required API resources on <code>deathstar</code>, thereby implementing a <strong>least privilege</strong> security approach for communication between microservices. Note that path matches the exact url, if for example you want to allow anything under <code>/v1/</code>, you need to use a regular expression.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a>path:<span class=w> </span><span class=s2>&quot;/v1/.*&quot;</span>
</code></pre></div> </div> <h3 id=locking-down-external-access-with-dns-based-policies>Locking Down External Access with DNS-Based Policies</h3> <p><strong>DNS-based</strong> policies are very useful for controlling access to services running <strong>outside</strong> the Kubernetes cluster. DNS acts as a persistent service identifier for both external services provided by AWS, Google, Twilio, Stripe, etc., and internal services such as database clusters running in private subnets outside Kubernetes. CIDR or IP-based policies are cumbersome and hard to maintain as the IPs associated with external services can change frequently. The Cilium <strong>DNS-based</strong> policies provide an easy mechanism to specify access control while Cilium manages the harder aspects of tracking DNS to IP mapping.</p> <p>In this example we will take a look to a simple scenario where the Empire's <code>mediabot</code> pods need access to <code>GitHub</code> for managing the Empire's git repositories. The pods <strong>shouldn't</strong> have access to any other external service.</p> <p><a class=glightbox href=../../../images/cilium_http_l3_l4_l7_dns.png data-type=image data-width=100% data-height=auto data-desc-position=bottom><img alt="Access with DNS-Based Policies" src=../../../images/cilium_http_l3_l4_l7_dns.png></a></p> <p>Deploy <code>mediabot</code> pod that will attempt to connect to github.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=c1># Create CiliumNetworkPolicy resource</span>
<a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>https://raw.githubusercontent.com/jsa4000/homelab-ops/main/docs/_source/layers/networking/cilium/dns-sw-app.yaml
</code></pre></div> <h4 id=apply-dns-egress-policy>Apply DNS Egress Policy</h4> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Since pods needs to resolve DNS or FQDN into IP Address it's necessary to allow access to kube-dns <code>endpoint/pod</code> (allow DNS lookups). Once the policy is apply it <strong>denies</strong> the rest of the incoming and outcoming traffic that do not match with it.</p> <p><strong>OpenShift</strong> users will need to modify the policies to match the namespace<code>openshift-dns</code> (instead of <code>kube-system</code>), remove the match on the <code>k8s:k8s-app=kube-dns</code> label, and change the port to <code>5353</code>.</p> </div> <div class=highlight><span class=filename>dns-matchname.yaml</span><pre><span></span><code><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=s>&quot;cilium.io/v2&quot;</span>
<a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">CiliumNetworkPolicy</span>
<a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-26-4 name=__codelineno-26-4 href=#__codelineno-26-4></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;fqdn&quot;</span>
<a id=__codelineno-26-5 name=__codelineno-26-5 href=#__codelineno-26-5></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-26-6 name=__codelineno-26-6 href=#__codelineno-26-6></a><span class=w>  </span><span class=nt>endpointSelector</span><span class=p>:</span>
<a id=__codelineno-26-7 name=__codelineno-26-7 href=#__codelineno-26-7></a><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span>
<a id=__codelineno-26-8 name=__codelineno-26-8 href=#__codelineno-26-8></a><span class=w>      </span><span class=nt>org</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">empire</span>
<a id=__codelineno-26-9 name=__codelineno-26-9 href=#__codelineno-26-9></a><span class=w>      </span><span class=nt>class</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mediabot</span>
<a id=__codelineno-26-10 name=__codelineno-26-10 href=#__codelineno-26-10></a><span class=w>  </span><span class=nt>egress</span><span class=p>:</span>
<a id=__codelineno-26-11 name=__codelineno-26-11 href=#__codelineno-26-11></a><span class=hll><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>toFQDNs</span><span class=p>:</span><span class=w> </span><span class=c1># (1)!</span>
</span><a id=__codelineno-26-12 name=__codelineno-26-12 href=#__codelineno-26-12></a><span class=hll><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>matchName</span><span class=p>:</span><span class=w> </span><span class=s>&quot;api.github.com&quot;</span>
</span><a id=__codelineno-26-13 name=__codelineno-26-13 href=#__codelineno-26-13></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>toEndpoints</span><span class=p>:</span><span class=w>  </span><span class=c1># (2)!</span>
<a id=__codelineno-26-14 name=__codelineno-26-14 href=#__codelineno-26-14></a><span class=hll><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>matchLabels</span><span class=p>:</span>
</span><a id=__codelineno-26-15 name=__codelineno-26-15 href=#__codelineno-26-15></a><span class=hll><span class=w>            </span><span class=s>&quot;k8s:io.kubernetes.pod.namespace&quot;</span><span class="p p-Indicator">:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
</span><a id=__codelineno-26-16 name=__codelineno-26-16 href=#__codelineno-26-16></a><span class=hll><span class=w>            </span><span class=s>&quot;k8s:k8s-app&quot;</span><span class="p p-Indicator">:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kube-dns</span>
</span><a id=__codelineno-26-17 name=__codelineno-26-17 href=#__codelineno-26-17></a><span class=w>      </span><span class=nt>toPorts</span><span class=p>:</span>
<a id=__codelineno-26-18 name=__codelineno-26-18 href=#__codelineno-26-18></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>ports</span><span class=p>:</span>
<a id=__codelineno-26-19 name=__codelineno-26-19 href=#__codelineno-26-19></a><span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=s>&quot;53&quot;</span>
<a id=__codelineno-26-20 name=__codelineno-26-20 href=#__codelineno-26-20></a><span class=w>              </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ANY</span>
<a id=__codelineno-26-21 name=__codelineno-26-21 href=#__codelineno-26-21></a><span class=hll><span class=w>          </span><span class=nt>rules</span><span class=p>:</span>
</span><a id=__codelineno-26-22 name=__codelineno-26-22 href=#__codelineno-26-22></a><span class=hll><span class=w>            </span><span class=nt>dns</span><span class=p>:</span>
</span><a id=__codelineno-26-23 name=__codelineno-26-23 href=#__codelineno-26-23></a><span class=hll><span class=w>              </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>matchPattern</span><span class=p>:</span><span class=w> </span><span class=s>&quot;*&quot;</span>
</span></code></pre></div> <ol> <li>The first egress section uses <code>toFQDNs:</code> matchName specification to allow egress to <code>api.github.com</code>. The destination DNS should match exactly the name specified in the rule. The endpointSelector allows only pods with labels <code>class: mediabot</code>, <code>org:empire</code> to have the egress access.</li> <li>The second egress section (<code>toEndpoints</code>) allows <code>mediabot</code> pods to access <code>kube-dns</code> service. Note that <code>rules: dns</code> instructs Cilium to inspect and allow DNS lookups matching specified patterns. In this case, inspect and allow all DNS queries.</li> </ol> <p>Apply DNS policy using DNS strict match</p> <div class=highlight><pre><span></span><code><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=c1># Apply the DNS Polidy</span>
<a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>https://raw.githubusercontent.com/jsa4000/homelab-ops/main/docs/_source/layers/networking/cilium/dns-matchname.yaml
</code></pre></div> <p>Testing the policy, we see that <code>mediabot</code> has access to <code>api.github.com</code> but doesn't have access to any other external service, e.g., <code>support.github.com</code>.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=c1># Verify the DNS match with the policy applied</span>
<a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>mediabot<span class=w> </span>--<span class=w> </span>curl<span class=w> </span>-I<span class=w> </span>-s<span class=w> </span>https://api.github.com<span class=w> </span><span class=p>|</span><span class=w> </span>head<span class=w> </span>-1
<a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a>HTTP/2<span class=w> </span><span class=m>200</span>
<a id=__codelineno-28-4 name=__codelineno-28-4 href=#__codelineno-28-4></a>
<a id=__codelineno-28-5 name=__codelineno-28-5 href=#__codelineno-28-5></a><span class=c1># Verify the DNS does not match with the policy applied</span>
<a id=__codelineno-28-6 name=__codelineno-28-6 href=#__codelineno-28-6></a>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>mediabot<span class=w> </span>--<span class=w> </span>curl<span class=w> </span>-I<span class=w> </span>-s<span class=w> </span>--max-time<span class=w> </span><span class=m>5</span><span class=w> </span>https://support.github.com<span class=w> </span><span class=p>|</span><span class=w> </span>head<span class=w> </span>-1
<a id=__codelineno-28-7 name=__codelineno-28-7 href=#__codelineno-28-7></a>
<a id=__codelineno-28-8 name=__codelineno-28-8 href=#__codelineno-28-8></a><span class=c1># The connections it&#39;s blocked by cilium</span>
</code></pre></div> <h4 id=dns-policies-using-patterns>DNS Policies Using Patterns</h4> <p>The above policy controlled DNS access based on exact match of the DNS domain name. Often, it is required to allow access to a subset of domains. Let's say, in the above example, mediabot pods need access to any GitHub sub-domain, e.g., the pattern <code>*.github.com</code>. We can achieve this easily by changing the <code>toFQDN</code> rule to use <code>matchPattern</code> instead of <code>matchName</code>.</p> <div class=highlight><span class=filename>dns-pattern.yaml</span><pre><span></span><code><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=s>&quot;cilium.io/v2&quot;</span>
<a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">CiliumNetworkPolicy</span>
<a id=__codelineno-29-3 name=__codelineno-29-3 href=#__codelineno-29-3></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-29-4 name=__codelineno-29-4 href=#__codelineno-29-4></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;fqdn&quot;</span>
<a id=__codelineno-29-5 name=__codelineno-29-5 href=#__codelineno-29-5></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-29-6 name=__codelineno-29-6 href=#__codelineno-29-6></a><span class=w>  </span><span class=nt>endpointSelector</span><span class=p>:</span>
<a id=__codelineno-29-7 name=__codelineno-29-7 href=#__codelineno-29-7></a><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span>
<a id=__codelineno-29-8 name=__codelineno-29-8 href=#__codelineno-29-8></a><span class=w>      </span><span class=nt>org</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">empire</span>
<a id=__codelineno-29-9 name=__codelineno-29-9 href=#__codelineno-29-9></a><span class=w>      </span><span class=nt>class</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mediabot</span>
<a id=__codelineno-29-10 name=__codelineno-29-10 href=#__codelineno-29-10></a><span class=w>  </span><span class=nt>egress</span><span class=p>:</span>
<a id=__codelineno-29-11 name=__codelineno-29-11 href=#__codelineno-29-11></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>toFQDNs</span><span class=p>:</span>
<a id=__codelineno-29-12 name=__codelineno-29-12 href=#__codelineno-29-12></a><span class=hll><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>matchPattern</span><span class=p>:</span><span class=w> </span><span class=s>&quot;*.github.com&quot;</span>
</span><a id=__codelineno-29-13 name=__codelineno-29-13 href=#__codelineno-29-13></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>toEndpoints</span><span class=p>:</span>
<a id=__codelineno-29-14 name=__codelineno-29-14 href=#__codelineno-29-14></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>matchLabels</span><span class=p>:</span>
<a id=__codelineno-29-15 name=__codelineno-29-15 href=#__codelineno-29-15></a><span class=w>            </span><span class=s>&quot;k8s:io.kubernetes.pod.namespace&quot;</span><span class="p p-Indicator">:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<a id=__codelineno-29-16 name=__codelineno-29-16 href=#__codelineno-29-16></a><span class=w>            </span><span class=s>&quot;k8s:k8s-app&quot;</span><span class="p p-Indicator">:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kube-dns</span>
<a id=__codelineno-29-17 name=__codelineno-29-17 href=#__codelineno-29-17></a><span class=w>      </span><span class=nt>toPorts</span><span class=p>:</span>
<a id=__codelineno-29-18 name=__codelineno-29-18 href=#__codelineno-29-18></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>ports</span><span class=p>:</span>
<a id=__codelineno-29-19 name=__codelineno-29-19 href=#__codelineno-29-19></a><span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=s>&quot;53&quot;</span>
<a id=__codelineno-29-20 name=__codelineno-29-20 href=#__codelineno-29-20></a><span class=w>              </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ANY</span>
<a id=__codelineno-29-21 name=__codelineno-29-21 href=#__codelineno-29-21></a><span class=w>          </span><span class=nt>rules</span><span class=p>:</span>
<a id=__codelineno-29-22 name=__codelineno-29-22 href=#__codelineno-29-22></a><span class=w>            </span><span class=nt>dns</span><span class=p>:</span>
<a id=__codelineno-29-23 name=__codelineno-29-23 href=#__codelineno-29-23></a><span class=w>              </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>matchPattern</span><span class=p>:</span><span class=w> </span><span class=s>&quot;*&quot;</span>
</code></pre></div> <p>Apply DNS policy using a pattern instead</p> <div class=highlight><pre><span></span><code><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a><span class=c1># Apply the DNS Policy with wildcards</span>
<a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>https://raw.githubusercontent.com/jsa4000/homelab-ops/main/docs/_source/layers/networking/cilium/dns-pattern.yaml
</code></pre></div> <p>Test that <code>mediabot</code> has access to multiple <strong>GitHub</strong> services for which the DNS matches the pattern <code>*.github.com</code>.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>It is important to note and test that this doesn't allow access to <code>github.com</code> because the <code>*.</code> in the pattern requires one subdomain to be present in the DNS name. You can simply add more <code>matchName</code> and <code>matchPattern</code> clauses to extend the access. (See DNS based policies to learn more about specifying DNS rules using patterns and names.)</p> </div> <div class=highlight><pre><span></span><code><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a><span class=c1># Verify the DNS match with the policy applied</span>
<a id=__codelineno-31-2 name=__codelineno-31-2 href=#__codelineno-31-2></a>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>mediabot<span class=w> </span>--<span class=w> </span>curl<span class=w> </span>-I<span class=w> </span>-s<span class=w> </span>https://api.github.com<span class=w> </span><span class=p>|</span><span class=w> </span>head<span class=w> </span>-1
<a id=__codelineno-31-3 name=__codelineno-31-3 href=#__codelineno-31-3></a>HTTP/2<span class=w> </span><span class=m>200</span>
<a id=__codelineno-31-4 name=__codelineno-31-4 href=#__codelineno-31-4></a>
<a id=__codelineno-31-5 name=__codelineno-31-5 href=#__codelineno-31-5></a><span class=c1># Verify the DNS match with the policy applied</span>
<a id=__codelineno-31-6 name=__codelineno-31-6 href=#__codelineno-31-6></a>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>mediabot<span class=w> </span>--<span class=w> </span>curl<span class=w> </span>-I<span class=w> </span>-s<span class=w> </span>--max-time<span class=w> </span><span class=m>5</span><span class=w> </span>https://support.github.com<span class=w> </span><span class=p>|</span><span class=w> </span>head<span class=w> </span>-1
<a id=__codelineno-31-7 name=__codelineno-31-7 href=#__codelineno-31-7></a>HTTP/2<span class=w> </span><span class=m>302</span>
<a id=__codelineno-31-8 name=__codelineno-31-8 href=#__codelineno-31-8></a>
<a id=__codelineno-31-9 name=__codelineno-31-9 href=#__codelineno-31-9></a><span class=c1># Verify the DNS does not match with the policy applied</span>
<a id=__codelineno-31-10 name=__codelineno-31-10 href=#__codelineno-31-10></a>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>mediabot<span class=w> </span>--<span class=w> </span>curl<span class=w> </span>-I<span class=w> </span>-s<span class=w> </span>--max-time<span class=w> </span><span class=m>5</span><span class=w> </span>https://github.com<span class=w> </span><span class=p>|</span><span class=w> </span>head<span class=w> </span>-1
<a id=__codelineno-31-11 name=__codelineno-31-11 href=#__codelineno-31-11></a>
<a id=__codelineno-31-12 name=__codelineno-31-12 href=#__codelineno-31-12></a><span class=c1># The connections it&#39;s blocked by cilium</span>
</code></pre></div> <h4 id=combining-dns-port-and-l7-rules>Combining DNS, Port and L7 Rules</h4> <p>The DNS-based policies can be combined with port (L4) and API (L7) rules to further restrict the access. In our example, we will restrict <code>mediabot</code> pods to access GitHub services only on ports <code>443</code>. The <code>toPorts</code> section in the policy below achieves the port-based restrictions along with the DNS-based policies.</p> <div class=highlight><span class=filename>dns-port.yaml</span><pre><span></span><code><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=s>&quot;cilium.io/v2&quot;</span>
<a id=__codelineno-32-2 name=__codelineno-32-2 href=#__codelineno-32-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">CiliumNetworkPolicy</span>
<a id=__codelineno-32-3 name=__codelineno-32-3 href=#__codelineno-32-3></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-32-4 name=__codelineno-32-4 href=#__codelineno-32-4></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;fqdn&quot;</span>
<a id=__codelineno-32-5 name=__codelineno-32-5 href=#__codelineno-32-5></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-32-6 name=__codelineno-32-6 href=#__codelineno-32-6></a><span class=w>  </span><span class=nt>endpointSelector</span><span class=p>:</span>
<a id=__codelineno-32-7 name=__codelineno-32-7 href=#__codelineno-32-7></a><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span>
<a id=__codelineno-32-8 name=__codelineno-32-8 href=#__codelineno-32-8></a><span class=w>      </span><span class=nt>org</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">empire</span>
<a id=__codelineno-32-9 name=__codelineno-32-9 href=#__codelineno-32-9></a><span class=w>      </span><span class=nt>class</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mediabot</span>
<a id=__codelineno-32-10 name=__codelineno-32-10 href=#__codelineno-32-10></a><span class=w>  </span><span class=nt>egress</span><span class=p>:</span>
<a id=__codelineno-32-11 name=__codelineno-32-11 href=#__codelineno-32-11></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>toFQDNs</span><span class=p>:</span>
<a id=__codelineno-32-12 name=__codelineno-32-12 href=#__codelineno-32-12></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>matchPattern</span><span class=p>:</span><span class=w> </span><span class=s>&quot;*.github.com&quot;</span>
<a id=__codelineno-32-13 name=__codelineno-32-13 href=#__codelineno-32-13></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>matchName</span><span class=p>:</span><span class=w> </span><span class=s>&quot;github.com&quot;</span>
<a id=__codelineno-32-14 name=__codelineno-32-14 href=#__codelineno-32-14></a><span class=hll><span class=w>      </span><span class=nt>toPorts</span><span class=p>:</span>
</span><a id=__codelineno-32-15 name=__codelineno-32-15 href=#__codelineno-32-15></a><span class=hll><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>ports</span><span class=p>:</span>
</span><a id=__codelineno-32-16 name=__codelineno-32-16 href=#__codelineno-32-16></a><span class=hll><span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=s>&quot;443&quot;</span>
</span><a id=__codelineno-32-17 name=__codelineno-32-17 href=#__codelineno-32-17></a><span class=hll><span class=w>              </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
</span><a id=__codelineno-32-18 name=__codelineno-32-18 href=#__codelineno-32-18></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>toEndpoints</span><span class=p>:</span>
<a id=__codelineno-32-19 name=__codelineno-32-19 href=#__codelineno-32-19></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>matchLabels</span><span class=p>:</span>
<a id=__codelineno-32-20 name=__codelineno-32-20 href=#__codelineno-32-20></a><span class=w>            </span><span class=s>&quot;k8s:io.kubernetes.pod.namespace&quot;</span><span class="p p-Indicator">:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<a id=__codelineno-32-21 name=__codelineno-32-21 href=#__codelineno-32-21></a><span class=w>            </span><span class=s>&quot;k8s:k8s-app&quot;</span><span class="p p-Indicator">:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kube-dns</span>
<a id=__codelineno-32-22 name=__codelineno-32-22 href=#__codelineno-32-22></a><span class=w>      </span><span class=nt>toPorts</span><span class=p>:</span>
<a id=__codelineno-32-23 name=__codelineno-32-23 href=#__codelineno-32-23></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>ports</span><span class=p>:</span>
<a id=__codelineno-32-24 name=__codelineno-32-24 href=#__codelineno-32-24></a><span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=s>&quot;53&quot;</span>
<a id=__codelineno-32-25 name=__codelineno-32-25 href=#__codelineno-32-25></a><span class=w>              </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ANY</span>
<a id=__codelineno-32-26 name=__codelineno-32-26 href=#__codelineno-32-26></a><span class=w>          </span><span class=nt>rules</span><span class=p>:</span>
<a id=__codelineno-32-27 name=__codelineno-32-27 href=#__codelineno-32-27></a><span class=w>            </span><span class=nt>dns</span><span class=p>:</span>
<a id=__codelineno-32-28 name=__codelineno-32-28 href=#__codelineno-32-28></a><span class=w>              </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>matchPattern</span><span class=p>:</span><span class=w> </span><span class=s>&quot;*&quot;</span>
</code></pre></div> <p>Apply DNS policy using a pattern instead</p> <div class=highlight><pre><span></span><code><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a><span class=c1># Apply the DNS Policy with ports</span>
<a id=__codelineno-33-2 name=__codelineno-33-2 href=#__codelineno-33-2></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>https://raw.githubusercontent.com/jsa4000/homelab-ops/main/docs/_source/layers/networking/cilium/dns-port.yaml
</code></pre></div> <p>Test that <code>mediabot</code> has access to multiple <strong>GitHub</strong> services for which the DNS matches both <code>github.com</code> and pattern <code>*.github.com</code>. The access on port <code>443</code> will succeed but the access on port <code>80</code> will be denied.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-34-1 name=__codelineno-34-1 href=#__codelineno-34-1></a><span class=c1># Verify the DNS match with the policy applied on port 443</span>
<a id=__codelineno-34-2 name=__codelineno-34-2 href=#__codelineno-34-2></a>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>mediabot<span class=w> </span>--<span class=w> </span>curl<span class=w> </span>-I<span class=w> </span>-s<span class=w> </span>https://api.github.com<span class=w> </span><span class=p>|</span><span class=w> </span>head<span class=w> </span>-1
<a id=__codelineno-34-3 name=__codelineno-34-3 href=#__codelineno-34-3></a>HTTP/2<span class=w> </span><span class=m>200</span>
<a id=__codelineno-34-4 name=__codelineno-34-4 href=#__codelineno-34-4></a>
<a id=__codelineno-34-5 name=__codelineno-34-5 href=#__codelineno-34-5></a><span class=c1># Verify the DNS match with the policy applied on port 443</span>
<a id=__codelineno-34-6 name=__codelineno-34-6 href=#__codelineno-34-6></a>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>mediabot<span class=w> </span>--<span class=w> </span>curl<span class=w> </span>-I<span class=w> </span>-s<span class=w> </span>--max-time<span class=w> </span><span class=m>5</span><span class=w> </span>https://support.github.com<span class=w> </span><span class=p>|</span><span class=w> </span>head<span class=w> </span>-1
<a id=__codelineno-34-7 name=__codelineno-34-7 href=#__codelineno-34-7></a>HTTP/2<span class=w> </span><span class=m>302</span>
<a id=__codelineno-34-8 name=__codelineno-34-8 href=#__codelineno-34-8></a>
<a id=__codelineno-34-9 name=__codelineno-34-9 href=#__codelineno-34-9></a><span class=c1># Verify the DNS match with the policy applied on port 443</span>
<a id=__codelineno-34-10 name=__codelineno-34-10 href=#__codelineno-34-10></a>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>mediabot<span class=w> </span>--<span class=w> </span>curl<span class=w> </span>-I<span class=w> </span>-s<span class=w> </span>--max-time<span class=w> </span><span class=m>5</span><span class=w> </span>https://github.com<span class=w> </span><span class=p>|</span><span class=w> </span>head<span class=w> </span>-1
<a id=__codelineno-34-11 name=__codelineno-34-11 href=#__codelineno-34-11></a>
<a id=__codelineno-34-12 name=__codelineno-34-12 href=#__codelineno-34-12></a><span class=c1># Verify the DNS match with the policy applied on port 80</span>
<a id=__codelineno-34-13 name=__codelineno-34-13 href=#__codelineno-34-13></a>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>mediabot<span class=w> </span>--<span class=w> </span>curl<span class=w> </span>-I<span class=w> </span>-s<span class=w> </span>--max-time<span class=w> </span><span class=m>5</span><span class=w> </span>http://support.github.com<span class=w> </span><span class=p>|</span><span class=w> </span>head<span class=w> </span>-1
<a id=__codelineno-34-14 name=__codelineno-34-14 href=#__codelineno-34-14></a>
<a id=__codelineno-34-15 name=__codelineno-34-15 href=#__codelineno-34-15></a><span class=c1># The connections it&#39;s blocked by cilium</span>
</code></pre></div> <h3 id=inspecting-the-clusters-network-traffic-with-hubble-relay>Inspecting the cluster's network traffic with Hubble Relay</h3> <p>Let's now inspect this traffic using the CLI. The command below filters all traffic on the application layer (L7, HTTP) to the <code>deathstar</code> pod.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a><span class=c1># Observe HTTP traffic from deathstar pod</span>
<a id=__codelineno-35-2 name=__codelineno-35-2 href=#__codelineno-35-2></a>hubble<span class=w> </span>observe<span class=w> </span>--pod<span class=w> </span>deathstar<span class=w> </span>--protocol<span class=w> </span>http
<a id=__codelineno-35-3 name=__codelineno-35-3 href=#__codelineno-35-3></a>
<a id=__codelineno-35-4 name=__codelineno-35-4 href=#__codelineno-35-4></a>Apr<span class=w>  </span><span class=m>5</span><span class=w> </span><span class=m>21</span>:03:13.283:<span class=w> </span>default/tiefighter:42746<span class=w> </span><span class=o>(</span>ID:25698<span class=o>)</span><span class=w> </span>-&gt;<span class=w> </span>default/deathstar-b4b8ccfb5-w84sn:80<span class=w> </span><span class=o>(</span>ID:6822<span class=o>)</span><span class=w> </span>http-request<span class=w> </span>FORWARDED<span class=w> </span><span class=o>(</span>HTTP/1.1<span class=w> </span>POST<span class=w> </span>http://deathstar.default.svc.cluster.local/v1/request-landing<span class=o>)</span>
<a id=__codelineno-35-5 name=__codelineno-35-5 href=#__codelineno-35-5></a>Apr<span class=w>  </span><span class=m>5</span><span class=w> </span><span class=m>21</span>:03:13.283:<span class=w> </span>default/tiefighter:42746<span class=w> </span><span class=o>(</span>ID:25698<span class=o>)</span><span class=w> </span>&lt;-<span class=w> </span>default/deathstar-b4b8ccfb5-w84sn:80<span class=w> </span><span class=o>(</span>ID:6822<span class=o>)</span><span class=w> </span>http-response<span class=w> </span>FORWARDED<span class=w> </span><span class=o>(</span>HTTP/1.1<span class=w> </span><span class=m>200</span><span class=w> </span>1ms<span class=w> </span><span class=o>(</span>POST<span class=w> </span>http://deathstar.default.svc.cluster.local/v1/request-landing<span class=o>))</span>
<a id=__codelineno-35-6 name=__codelineno-35-6 href=#__codelineno-35-6></a>Apr<span class=w>  </span><span class=m>5</span><span class=w> </span><span class=m>21</span>:03:15.919:<span class=w> </span>default/tiefighter:44396<span class=w> </span><span class=o>(</span>ID:25698<span class=o>)</span><span class=w> </span>-&gt;<span class=w> </span>default/deathstar-b4b8ccfb5-f75xw:80<span class=w> </span><span class=o>(</span>ID:6822<span class=o>)</span><span class=w> </span>http-request<span class=w> </span>DROPPED<span class=w> </span><span class=o>(</span>HTTP/1.1<span class=w> </span>PUT<span class=w> </span>http://deathstar.default.svc.cluster.local/v1/exhaust-port<span class=o>)</span>
<a id=__codelineno-35-7 name=__codelineno-35-7 href=#__codelineno-35-7></a>Apr<span class=w>  </span><span class=m>5</span><span class=w> </span><span class=m>21</span>:03:15.919:<span class=w> </span>default/tiefighter:44396<span class=w> </span><span class=o>(</span>ID:25698<span class=o>)</span><span class=w> </span>&lt;-<span class=w> </span>default/deathstar-b4b8ccfb5-f75xw:80<span class=w> </span><span class=o>(</span>ID:6822<span class=o>)</span><span class=w> </span>http-response<span class=w> </span>FORWARDED<span class=w> </span><span class=o>(</span>HTTP/1.1<span class=w> </span><span class=m>403</span><span class=w> </span>0ms<span class=w> </span><span class=o>(</span>PUT<span class=w> </span>http://deathstar.default.svc.cluster.local/v1/exhaust-port<span class=o>))</span>
<a id=__codelineno-35-8 name=__codelineno-35-8 href=#__codelineno-35-8></a>
<a id=__codelineno-35-9 name=__codelineno-35-9 href=#__codelineno-35-9></a><span class=c1># Observe al DROPPED traffic from deathstar pod</span>
<a id=__codelineno-35-10 name=__codelineno-35-10 href=#__codelineno-35-10></a>hubble<span class=w> </span>observe<span class=w> </span>--pod<span class=w> </span>deathstar<span class=w> </span>--verdict<span class=w> </span>DROPPED
<a id=__codelineno-35-11 name=__codelineno-35-11 href=#__codelineno-35-11></a>
<a id=__codelineno-35-12 name=__codelineno-35-12 href=#__codelineno-35-12></a>Apr<span class=w>  </span><span class=m>5</span><span class=w> </span><span class=m>21</span>:03:15.919:<span class=w> </span>default/tiefighter:44396<span class=w> </span><span class=o>(</span>ID:25698<span class=o>)</span><span class=w> </span>-&gt;<span class=w> </span>default/deathstar-b4b8ccfb5-f75xw:80<span class=w> </span><span class=o>(</span>ID:6822<span class=o>)</span><span class=w> </span>http-request<span class=w> </span>DROPPED<span class=w> </span><span class=o>(</span>HTTP/1.1<span class=w> </span>PUT<span class=w> </span>http://deathstar.default.svc.cluster.local/v1/exhaust-port<span class=o>)</span>
<a id=__codelineno-35-13 name=__codelineno-35-13 href=#__codelineno-35-13></a>Apr<span class=w>  </span><span class=m>5</span><span class=w> </span><span class=m>21</span>:03:18.803:<span class=w> </span>default/xwing:45706<span class=w> </span><span class=o>(</span>ID:63406<span class=o>)</span><span class=w> </span>&lt;&gt;<span class=w> </span>default/deathstar-b4b8ccfb5-f75xw:80<span class=w> </span><span class=o>(</span>ID:6822<span class=o>)</span><span class=w> </span>policy-verdict:none<span class=w> </span>INGRESS<span class=w> </span>DENIED<span class=w> </span><span class=o>(</span>TCP<span class=w> </span>Flags:<span class=w> </span>SYN<span class=o>)</span>
<a id=__codelineno-35-14 name=__codelineno-35-14 href=#__codelineno-35-14></a>Apr<span class=w>  </span><span class=m>5</span><span class=w> </span><span class=m>21</span>:03:18.803:<span class=w> </span>default/xwing:45706<span class=w> </span><span class=o>(</span>ID:63406<span class=o>)</span><span class=w> </span>&lt;&gt;<span class=w> </span>default/deathstar-b4b8ccfb5-f75xw:80<span class=w> </span><span class=o>(</span>ID:6822<span class=o>)</span><span class=w> </span>Policy<span class=w> </span>denied<span class=w> </span>DROPPED<span class=w> </span><span class=o>(</span>TCP<span class=w> </span>Flags:<span class=w> </span>SYN<span class=o>)</span>
<a id=__codelineno-35-15 name=__codelineno-35-15 href=#__codelineno-35-15></a>Apr<span class=w>  </span><span class=m>5</span><span class=w> </span><span class=m>21</span>:03:19.820:<span class=w> </span>default/xwing:45706<span class=w> </span><span class=o>(</span>ID:63406<span class=o>)</span><span class=w> </span>&lt;&gt;<span class=w> </span>default/deathstar-b4b8ccfb5-f75xw:80<span class=w> </span><span class=o>(</span>ID:6822<span class=o>)</span><span class=w> </span>policy-verdict:none<span class=w> </span>INGRESS<span class=w> </span>DENIED<span class=w> </span><span class=o>(</span>TCP<span class=w> </span>Flags:<span class=w> </span>SYN<span class=o>)</span>
<a id=__codelineno-35-16 name=__codelineno-35-16 href=#__codelineno-35-16></a>Apr<span class=w>  </span><span class=m>5</span><span class=w> </span><span class=m>21</span>:03:19.820:<span class=w> </span>default/xwing:45706<span class=w> </span><span class=o>(</span>ID:63406<span class=o>)</span><span class=w> </span>&lt;&gt;<span class=w> </span>default/deathstar-b4b8ccfb5-f75xw:80<span class=w> </span><span class=o>(</span>ID:6822<span class=o>)</span><span class=w> </span>Policy<span class=w> </span>denied<span class=w> </span>DROPPED<span class=w> </span><span class=o>(</span>TCP<span class=w> </span>Flags:<span class=w> </span>SYN<span class=o>)</span>
<a id=__codelineno-35-17 name=__codelineno-35-17 href=#__codelineno-35-17></a>Apr<span class=w>  </span><span class=m>5</span><span class=w> </span><span class=m>21</span>:03:21.836:<span class=w> </span>default/xwing:45706<span class=w> </span><span class=o>(</span>ID:63406<span class=o>)</span><span class=w> </span>&lt;&gt;<span class=w> </span>default/deathstar-b4b8ccfb5-f75xw:80<span class=w> </span><span class=o>(</span>ID:6822<span class=o>)</span><span class=w> </span>policy-verdict:none<span class=w> </span>INGRESS<span class=w> </span>DENIED<span class=w> </span><span class=o>(</span>TCP<span class=w> </span>Flags:<span class=w> </span>SYN<span class=o>)</span>
<a id=__codelineno-35-18 name=__codelineno-35-18 href=#__codelineno-35-18></a>Apr<span class=w>  </span><span class=m>5</span><span class=w> </span><span class=m>21</span>:03:21.836:<span class=w> </span>default/xwing:45706<span class=w> </span><span class=o>(</span>ID:63406<span class=o>)</span><span class=w> </span>&lt;&gt;<span class=w> </span>default/deathstar-b4b8ccfb5-f75xw:80<span class=w> </span><span class=o>(</span>ID:6822<span class=o>)</span><span class=w> </span>Policy<span class=w> </span>denied<span class=w> </span>DROPPED<span class=w> </span><span class=o>(</span>TCP<span class=w> </span>Flags:<span class=w> </span>SYN<span class=o>)</span>
<a id=__codelineno-35-19 name=__codelineno-35-19 href=#__codelineno-35-19></a>Apr<span class=w>  </span><span class=m>5</span><span class=w> </span><span class=m>21</span>:03:25.965:<span class=w> </span>default/xwing:45706<span class=w> </span><span class=o>(</span>ID:63406<span class=o>)</span><span class=w> </span>&lt;&gt;<span class=w> </span>default/deathstar-b4b8ccfb5-f75xw:80<span class=w> </span><span class=o>(</span>ID:6822<span class=o>)</span><span class=w> </span>policy-verdict:none<span class=w> </span>INGRESS<span class=w> </span>DENIED<span class=w> </span><span class=o>(</span>TCP<span class=w> </span>Flags:<span class=w> </span>SYN<span class=o>)</span>
<a id=__codelineno-35-20 name=__codelineno-35-20 href=#__codelineno-35-20></a>Apr<span class=w>  </span><span class=m>5</span><span class=w> </span><span class=m>21</span>:03:25.965:<span class=w> </span>default/xwing:45706<span class=w> </span><span class=o>(</span>ID:63406<span class=o>)</span><span class=w> </span>&lt;&gt;<span class=w> </span>default/deathstar-b4b8ccfb5-f75xw:80<span class=w> </span><span class=o>(</span>ID:6822<span class=o>)</span><span class=w> </span>Policy<span class=w> </span>denied<span class=w> </span>DROPPED<span class=w> </span><span class=o>(</span>TCP<span class=w> </span>Flags:<span class=w> </span>SYN<span class=o>)</span>
<a id=__codelineno-35-21 name=__codelineno-35-21 href=#__codelineno-35-21></a>Apr<span class=w>  </span><span class=m>5</span><span class=w> </span><span class=m>21</span>:03:34.156:<span class=w> </span>default/xwing:45706<span class=w> </span><span class=o>(</span>ID:63406<span class=o>)</span><span class=w> </span>&lt;&gt;<span class=w> </span>default/deathstar-b4b8ccfb5-f75xw:80<span class=w> </span><span class=o>(</span>ID:6822<span class=o>)</span><span class=w> </span>policy-verdict:none<span class=w> </span>INGRESS<span class=w> </span>DENIED<span class=w> </span><span class=o>(</span>TCP<span class=w> </span>Flags:<span class=w> </span>SYN<span class=o>)</span>
<a id=__codelineno-35-22 name=__codelineno-35-22 href=#__codelineno-35-22></a>Apr<span class=w>  </span><span class=m>5</span><span class=w> </span><span class=m>21</span>:03:34.156:<span class=w> </span>default/xwing:45706<span class=w> </span><span class=o>(</span>ID:63406<span class=o>)</span><span class=w> </span>&lt;&gt;<span class=w> </span>default/deathstar-b4b8ccfb5-f75xw:80<span class=w> </span><span class=o>(</span>ID:6822<span class=o>)</span><span class=w> </span>Policy<span class=w> </span>denied<span class=w> </span>DROPPED<span class=w> </span><span class=o>(</span>TCP<span class=w> </span>Flags:<span class=w> </span>SYN<span class=o>)</span>
<a id=__codelineno-35-23 name=__codelineno-35-23 href=#__codelineno-35-23></a>Apr<span class=w>  </span><span class=m>5</span><span class=w> </span><span class=m>21</span>:03:50.285:<span class=w> </span>default/xwing:45706<span class=w> </span><span class=o>(</span>ID:63406<span class=o>)</span><span class=w> </span>&lt;&gt;<span class=w> </span>default/deathstar-b4b8ccfb5-f75xw:80<span class=w> </span><span class=o>(</span>ID:6822<span class=o>)</span><span class=w> </span>policy-verdict:none<span class=w> </span>INGRESS<span class=w> </span>DENIED<span class=w> </span><span class=o>(</span>TCP<span class=w> </span>Flags:<span class=w> </span>SYN<span class=o>)</span>
<a id=__codelineno-35-24 name=__codelineno-35-24 href=#__codelineno-35-24></a>Apr<span class=w>  </span><span class=m>5</span><span class=w> </span><span class=m>21</span>:03:50.285:<span class=w> </span>default/xwing:45706<span class=w> </span><span class=o>(</span>ID:63406<span class=o>)</span><span class=w> </span>&lt;&gt;<span class=w> </span>default/deathstar-b4b8ccfb5-f75xw:80<span class=w> </span><span class=o>(</span>ID:6822<span class=o>)</span><span class=w> </span>Policy<span class=w> </span>denied<span class=w> </span>DROPPED<span class=w> </span><span class=o>(</span>TCP<span class=w> </span>Flags:<span class=w> </span>SYN<span class=o>)</span>
</code></pre></div> <h2 id=labs>Labs</h2> <ul> <li><a href=https://isovalent.com/labs/cilium-lb-ipam-l2-announcements/ >IPAM and L2 Service Announcement Lab</a></li> </ul> <h2 id=references>References</h2> <ul> <li><a href=https://medium.com/@valentin.hristev/kubernetes-loadbalance-service-using-cilium-bgp-control-plane-8a5ad416546a>Kubernetes LoadBalance service using Cilium BGP control plane</a></li> <li><a href=https://blog.stonegarden.dev/articles/2023/12/migrating-from-metallb-to-cilium/ >Migrating from MetaLB to Cilium</a></li> <li><a href=https://docs.cilium.io/en/stable/gettingstarted/demo/ >Getting Started with the Star Wars Demo</a></li> </ul> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title="Last update"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1-2.1-2M12.5 7v5.2l4 2.4-1 1L11 13V7h1.5M11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2v1.8Z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">February 13, 2025</span> </span> </aside> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> &copy; 2024 <a href=https://github.com/jsa4000 target=_blank rel=noopener>Javier Santos</a> </div> </div> <div class=md-social> <a href=https://github.com/jsa4000 target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </a> <a href=https://github.com/jsa4000 target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg> </a> <a href=https://www.linkedin.com/in/javier-santos-andres/ target=_blank rel=noopener title=www.linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["header.autohide", "navigation.tabs", "navigation.top", "navigation.instant", "navigation.tracking", "toc.integrate", "search.suggest", "search.share", "search.highlight", "content.tabs.link", "content.code.annotation", "content.code.annotate", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../../assets/javascripts/bundle.c8d2eff1.min.js></script> <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body> </html>